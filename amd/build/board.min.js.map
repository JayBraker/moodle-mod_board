{"version":3,"sources":["../src/board.js"],"names":["define","$","Str","Ajax","Notification","_serviceCall","method","args","callback","failcallback","call","methodname","done","data","bind","fail","error","exception","isAriaTriggerKey","key","handleAction","elem","on","e","type","keyCode","preventDefault","handleEditableAction","callBeforeOnKeyEditing","is","Error","editable","board","options","strings","default_column_heading","post_button_text","cancel_button_text","remove_note_text","remove_column_text","note_changed_text","note_deleted_text","Ok","Cancel","warning","option_youtube","option_youtube_info","option_youtube_url","option_image","option_image_info","option_image_url","option_link","option_link_info","option_link_url","option_empty","aria_newcolumn","aria_newpost","aria_deletecolumn","aria_deletepost","aria_addmedia","aria_addmedianew","aria_deleteattachment","aria_postedit","aria_canceledit","aria_postnew","aria_cancelnew","MEDIA_SELECTION_BUTTONS","reloadTimer","lastHistoryId","isEditor","userId","mediaSelection","mediaselection","noteTextCache","noteHeadingCache","attachmentCache","editingNote","isReadOnlyBoard","readonly","serviceCall","stopUpdating","apply","arguments","updateBoard","getNote","ident","getNoteText","getNoteTextForNote","note","find","getNoteHeading","getNoteHeadingForNote","getNoteButtonsForNote","showNewNoteButtons","show","hideNewNoteButtons","hide","getNoteAttachmentsForNote","textIdentifierForNote","noteText","html","noteHeading","noteAttachment","attachmentDataForNote","length","replace","split","slice","join","info","updateNoteAria","noteId","columnIdentifier","closest","text","post_button","cancel_button","add_youtube","add_image","add_link","remove_attachment","noteIdentifier","attr","attRemove","updateColumnAria","columnId","column","each","index","successNoteEdit","stopNoteEdit","remove","setAttachment","previewAttachment","startNoteEdit","pendingNote","deleteNote","confirm","id","result","status","historyid","attachmentTypeChanged","val","attachmentInfo","attachmentUrl","attachmentIcon","removeAttachment","prop","attachmentTypeToString","removeClass","addClass","attachmentFAIcon","attachment","attType","url","attachmentFAIcons","fixEmbedUrlIfNeeded","parseInt","addNote","columnid","heading","content","owner","ismynote","iseditable","notecontent","noteAriaText","attachmentPreview","append","attachmentType","trigger","column_content","buttons","postbutton","cancelbutton","ytButton","imgButton","linkButton","removeElement","beginEdit","sendAttach","theHeading","theText","substring","post_max_length","sortNotes","toggleFontSize","closeOnEnter","lastOne","last","insertAfter","prepend","addColumn","name","notes","nameCache","column_header","column_sort","column_name","column_newcontent","noteicon","userid","addNewColumnButton","newBusy","columnicon","boardid","processBoardHistory","since","boardhistory","item","JSON","parse","action","updateNote","alert","instant","setTimeout","clearTimeout","toggle","sort_col","parent","direction","sort","a","b","appendTo","init","columns","stringsInfo","string","push","component","when","get_strings","results"],"mappings":"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","sourcesContent":["define(['jquery', 'core/str', 'core/ajax', 'core/notification', 'core/templates', 'mod_board/jquery.editable.amd'], function($, Str, Ajax, Notification, Templates) {\r\n    \r\n    var _serviceCall = function(method, args, callback, failcallback) {\r\n        Ajax.call([{\r\n            methodname: 'mod_board_' + method,\r\n            args: args,\r\n            done: function(data) {\r\n                callback(data);\r\n            }.bind(this),\r\n            fail: function(error) {\r\n                Notification.exception(error);\r\n                if (failcallback) {\r\n                    failcallback(error);\r\n                }\r\n            }\r\n        }]);\r\n    };\r\n    \r\n    var isAriaTriggerKey = function(key) {\r\n        return key==13 || key==32;\r\n    };\r\n    \r\n    var handleAction = function(elem, callback) {\r\n        return elem.on('click keypress', function(e) {\r\n            if (e.type=='keypress') {\r\n                if (isAriaTriggerKey(e.keyCode)) {\r\n                    e.preventDefault();\r\n                } else {\r\n                    return;\r\n                }\r\n            }\r\n            \r\n            callback();\r\n        });\r\n    };\r\n    \r\n    var handleEditableAction = function(elem, callback, callBeforeOnKeyEditing) {\r\n        if (elem.is(':editable')) {\r\n            throw new Error('handleEditableAction - must be called before setting the element as editable');\r\n        }\r\n        \r\n        // can't use on(edit) here because we want to do actions (save cache) before the control goes into edit mode\r\n        return elem.on('dblclick keypress', function(e) {\r\n            if (e.type=='keypress') {\r\n                if (isAriaTriggerKey(e.keyCode) && !elem.is(':editing')) {\r\n                    e.preventDefault();\r\n                    if (callBeforeOnKeyEditing) {\r\n                        callback();\r\n                    }\r\n                    elem.editable('open');\r\n                    if (callBeforeOnKeyEditing) {\r\n                        return;\r\n                    }\r\n                } else {\r\n                    return;\r\n                }\r\n            }\r\n            \r\n            callback();\r\n        });\r\n    };\r\n        \r\n    return function(board, options) {\r\n        var strings = {\r\n            default_column_heading: '',\r\n            post_button_text: '',\r\n            cancel_button_text: '',\r\n            remove_note_text: '',\r\n            remove_column_text: '',\r\n            note_changed_text: '',\r\n            note_deleted_text: '',\r\n            Ok: '',\r\n            Cancel: '',\r\n            warning: '',\r\n            option_youtube: '',\r\n            option_youtube_info: '',\r\n            option_youtube_url: '',\r\n            option_image: '',\r\n            option_image_info: '',\r\n            option_image_url: '',\r\n            option_link: '',\r\n            option_link_info: '',\r\n            option_link_url: '',\r\n            option_empty: '',\r\n            \r\n            aria_newcolumn: '',\r\n            aria_newpost: '',\r\n            aria_deletecolumn: '',\r\n            aria_deletepost: '',\r\n            aria_addmedia: '',\r\n            aria_addmedianew: '',\r\n            aria_deleteattachment: '',\r\n            aria_postedit: '',\r\n            aria_canceledit: '',\r\n            aria_postnew: '',\r\n            aria_cancelnew: '',\r\n        };\r\n        \r\n        const MEDIA_SELECTION_BUTTONS = 1;\r\n        const MEDIA_SELECTION_DROPDOWN = 2;\r\n        var reloadTimer = null;\r\n        var lastHistoryId = null;\r\n        var isEditor = options.isEditor || false;\r\n        var userId = options.userId || -1;\r\n        var mediaSelection = options.mediaselection || MEDIA_SELECTION_BUTTONS;\r\n        var noteTextCache = null, noteHeadingCache = null, attachmentCache = null;\r\n        var editingNote = 0;\r\n        var isReadOnlyBoard = options.readonly || false;\r\n        \r\n        var serviceCall = function(method, args, callback, failcallback) {\r\n            if (method!=='board_history') {\r\n                stopUpdating();\r\n            }\r\n            _serviceCall(method, args, function() {\r\n                callback.apply(null, arguments);\r\n                if (method!=='board_history') {\r\n                    updateBoard(true);\r\n                }\r\n            }, failcallback);\r\n        };\r\n        \r\n        var getNote = function(ident) {\r\n            return $(\".board_note[data-ident='\"+ident+\"']\");\r\n        };\r\n        \r\n        var getNoteText = function(ident) {\r\n            return $(\".board_note[data-ident='\"+ident+\"'] .note_text\");\r\n        };\r\n        \r\n        var getNoteTextForNote = function(note) {\r\n            return $(note).find(\".note_text\");\r\n        };\r\n        \r\n        var getNoteHeading = function(ident) {\r\n            return $(\".board_note[data-ident='\"+ident+\"'] .note_heading\");\r\n        };\r\n        \r\n        var getNoteHeadingForNote = function(note) {\r\n            return $(note).find(\".note_heading\");\r\n        };\r\n        \r\n        var getNoteButtonsForNote = function(note) {\r\n            return $(note).find(\".note_buttons\");\r\n        };\r\n        \r\n        var showNewNoteButtons = function() {\r\n            $('.board_column .board_column_newcontent .board_button.newnote').show();\r\n        };\r\n        \r\n        var hideNewNoteButtons = function() {\r\n            $('.board_column .board_column_newcontent .board_button.newnote').hide();\r\n        };\r\n        \r\n        var getNoteAttachmentsForNote = function(note) {\r\n            return $(note).find(\".note_attachment\");\r\n        };\r\n        \r\n        var textIdentifierForNote = function(note) {\r\n            var noteText = getNoteTextForNote(note).html();\r\n            var noteHeading = getNoteHeadingForNote(note).html();\r\n            var noteAttachment = attachmentDataForNote(note);\r\n            \r\n            if (noteHeading.length>0) {\r\n                return noteHeading;\r\n            }\r\n            if (noteText.length>0) {\r\n                return noteText.replace(/<br\\s*\\/?>/gi,\" \").replace(/\\n/g, \" \").split(/\\s+/).slice(0,5).join(\" \");\r\n            }\r\n            if (noteAttachment.info && noteAttachment.info.length>0) {\r\n                return noteAttachment.info;\r\n            }\r\n            return null;\r\n        };\r\n        \r\n        var updateNoteAria = function(noteId) {\r\n            var note = getNote(noteId);\r\n            var columnIdentifier = note.closest('.board_column').find('.column_name').text();\r\n            var post_button = cancel_button = add_youtube = add_image = add_link = remove_attachment = \"\";\r\n            \r\n            if (!noteId) { // new post\r\n                post_button = strings.aria_postnew.replace('{column}', columnIdentifier);\r\n                cancel_button = strings.aria_cancelnew.replace('{column}', columnIdentifier);\r\n                add_youtube = strings.aria_addmedianew.replace('{type}', strings.option_youtube).replace('{column}', columnIdentifier);\r\n                add_image = strings.aria_addmedianew.replace('{type}', strings.option_image).replace('{column}', columnIdentifier);\r\n                add_link = strings.aria_addmedianew.replace('{type}', strings.option_link).replace('{column}', columnIdentifier);\r\n            } else {\r\n                var noteIdentifier = textIdentifierForNote(note);\r\n                \r\n                post_button = strings.aria_postedit.replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\r\n                cancel_button = strings.aria_canceledit.replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\r\n                add_youtube = strings.aria_addmedia.replace('{type}', strings.option_youtube).replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\r\n                add_image = strings.aria_addmedia.replace('{type}', strings.option_image).replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\r\n                add_link = strings.aria_addmedia.replace('{type}', strings.option_link).replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\r\n                remove_attachment = strings.aria_deleteattachment.replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\r\n                \r\n                note.find('.delete_note').attr('aria-label', strings.aria_deletepost.replace('{column}', columnIdentifier).replace('{post}', noteIdentifier));\r\n                note.find('.note_ariatext').html(noteIdentifier);\r\n            }\r\n            \r\n            if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                if (noteId) {\r\n                    var attRemove = note.find('.remove_attachment');\r\n                    if (attRemove) {\r\n                        attRemove.attr('aria-label', remove_attachment);\r\n                    }\r\n                }\r\n                \r\n                note.find('.attachment_button.youtube_button').attr('aria-label', add_youtube);\r\n                note.find('.attachment_button.image_button').attr('aria-label', add_image);\r\n                note.find('.attachment_button.link_button').attr('aria-label', add_link);\r\n            }\r\n            note.find('.post_button').attr('aria-label', post_button);\r\n            note.find('.cancel_button').attr('aria-label', cancel_button);\r\n        };\r\n        \r\n        var updateColumnAria = function(columnId) {\r\n            var column = $('.board_column[data-ident='+columnId+']');\r\n            var columnIdentifier = column.find('.column_name').text();\r\n            column.find('.newnote').attr('aria-label', strings.aria_newpost.replace('{column}', columnIdentifier));\r\n            column.find('.delete_column').attr('aria-label', strings.aria_deletecolumn.replace('{column}', columnIdentifier));\r\n            \r\n            column.find(\".board_note\").each(function(index, note) {\r\n                updateNoteAria($(note).data('ident'));\r\n            });\r\n        };\r\n        \r\n        var successNoteEdit = function() {\r\n            noteTextCache = null;\r\n            noteHeadingCache = null;\r\n            attachmentCache = null;\r\n            stopNoteEdit();\r\n        };\r\n        \r\n        var stopNoteEdit = function() {\r\n            if (!editingNote) {\r\n                getNote(0).remove();\r\n                showNewNoteButtons();\r\n                return;\r\n            }\r\n            \r\n            if (noteTextCache) {\r\n                getNoteText(editingNote).html(noteTextCache);\r\n                noteTextCache = null;\r\n            }\r\n            \r\n            if (noteHeadingCache) {\r\n                getNoteHeading(editingNote).html(noteHeadingCache);\r\n                noteHeadingCache = null;\r\n            }\r\n            \r\n            var note = getNote(editingNote);\r\n            \r\n            if (note) {\r\n                if (attachmentCache) {\r\n                    setAttachment(note, attachmentCache);\r\n                    attachmentCache = null;\r\n                } else {\r\n                    previewAttachment(note);\r\n                }\r\n\r\n                getNoteButtonsForNote(note).hide();\r\n                getNoteAttachmentsForNote(note).hide();\r\n                showNewNoteButtons();\r\n                var noteHeading = getNoteHeadingForNote(note);\r\n                if (!noteHeading.html()) {\r\n                    noteHeading.hide();\r\n                }\r\n            }\r\n            \r\n            editingNote = 0;\r\n        };\r\n        \r\n        var startNoteEdit = function(ident) {\r\n            if (editingNote) {\r\n                if (editingNote==ident) {\r\n                    return;\r\n                }\r\n                stopNoteEdit();\r\n            }\r\n            \r\n            if (ident) {\r\n                var pendingNote = getNote(0);\r\n                if (pendingNote) {\r\n                    pendingNote.remove();\r\n                }\r\n            }\r\n            \r\n            var note = getNote(ident);\r\n            if (note) {\r\n                getNoteButtonsForNote(note).show();\r\n                getNoteAttachmentsForNote(note).show();\r\n                hideNewNoteButtons();\r\n                \r\n                var noteHeading = getNoteHeadingForNote(note);\r\n                if (ident) {\r\n                    attachmentCache = attachmentDataForNote(note);\r\n                    noteTextCache = getNoteTextForNote(note).html();\r\n                    noteHeadingCache = noteHeading.html();\r\n                    editingNote = ident;\r\n                }\r\n                noteHeading.show();\r\n            }\r\n        };\r\n        \r\n        var deleteNote = function(ident) {\r\n            if (confirm(strings.remove_note_text)) {\r\n                serviceCall('delete_note', {id: ident}, function(result) {\r\n                    if (result.status) {\r\n                        lastHistoryId = result.historyid;\r\n                        getNote(ident).remove();\r\n                    }\r\n                });\r\n            }\r\n        };\r\n        \r\n        var attachmentTypeChanged = function(note) {\r\n            var noteAttachment = getNoteAttachmentsForNote(note);\r\n            var type = noteAttachment.find('.type').val();\r\n            \r\n            var attachmentInfo = noteAttachment.find('.info');\r\n            var attachmentUrl = noteAttachment.find('.url');\r\n            \r\n            if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                var attachmentIcon = noteAttachment.find('.type_icon');\r\n                var removeAttachment = noteAttachment.find('.remove_attachment');\r\n            } else {\r\n                getNoteButtonsForNote(note).find('.attachment_button').hide();\r\n            }\r\n                \r\n            if (type>\"0\") {\r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    removeAttachment.show();\r\n                }\r\n                attachmentInfo.prop('placeholder', strings['option_'+attachmentTypeToString(type)+'_info']);\r\n                attachmentUrl.prop('placeholder', strings['option_'+attachmentTypeToString(type)+'_url']);\r\n                \r\n                attachmentInfo.show();\r\n                attachmentUrl.show();\r\n                \r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    attachmentIcon.removeClass().addClass(['type_icon', 'fa', attachmentFAIcon(type)]);\r\n                    attachmentIcon.show();\r\n                    getNoteButtonsForNote(note).find('.attachment_button').hide();\r\n                }\r\n            } else {\r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    removeAttachment.hide();\r\n                }\r\n                attachmentInfo.hide();\r\n                attachmentUrl.hide();\r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    attachmentIcon.hide();\r\n                }\r\n                attachmentInfo.val('');\r\n                attachmentUrl.val('');\r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    getNoteButtonsForNote(note).find('.attachment_button').show();\r\n                }\r\n            }\r\n        }\r\n        \r\n        var setAttachment = function(note, attachment) {\r\n            var noteAttachment = getNoteAttachmentsForNote(note);\r\n            if (noteAttachment) {\r\n                if (!attachment) {\r\n                    attachment = {type: \"0\"};\r\n                } else {\r\n                    attachment.type += \"\";//just in case\r\n                }\r\n                var attType = noteAttachment.find('.type');\r\n                attType.val(attachment.type?attachment.type: \"0\");\r\n                if (attType.val()>\"0\") {\r\n                    noteAttachment.find('.info').val(attachment.info);\r\n                    noteAttachment.find('.url').val(attachment.url);\r\n                }\r\n                attachmentTypeChanged(note, attachment);\r\n            }\r\n            previewAttachment(note, attachment);\r\n        };\r\n        \r\n        var attachmentDataForNote = function(note) {\r\n            var attachment = { type: 0, info: null, url: null };\r\n            var noteAttachment = getNoteAttachmentsForNote(note);\r\n            if (noteAttachment) {\r\n                attachment.type = noteAttachment.find('.type').val();\r\n                attachment.info = noteAttachment.find('.info').val();\r\n                attachment.url = noteAttachment.find('.url').val();\r\n            }\r\n            if ((!attachment.info || !attachment.info.length) && (!attachment.url || !attachment.url.length)) {\r\n                attachment.type = 0;\r\n            }\r\n            \r\n            return attachment;\r\n        };\r\n        \r\n        var attachmentTypeToString = function(type) {\r\n            switch(type) {\r\n                case \"1\": return 'youtube';\r\n                case \"2\": return 'image';\r\n                case \"3\": return 'link';\r\n                default: return null;\r\n            }\r\n        };\r\n        \r\n        var attachmentFAIcons = ['fa-youtube', 'fa-picture-o', 'fa-link'];\r\n        var attachmentFAIcon = function(type) {\r\n            return attachmentFAIcons[type-1] || null;\r\n        }\r\n        \r\n        var previewAttachment = function(note, attachment) {\r\n            var elem = note.find('.preview');\r\n            if (!attachment) {\r\n                attachment = attachmentDataForNote(note);\r\n            }\r\n            var fixEmbedUrlIfNeeded = function(url) {\r\n                return url.replace(/watch\\?v=/gi, '/embed/').replace(/youtu\\.be/, 'youtube.com/embed');\r\n            };\r\n            \r\n            if (!getNoteTextForNote(note).html().length) {\r\n                elem.addClass('notext');\r\n            } else {\r\n                elem.removeClass('notext');\r\n            }\r\n            \r\n            elem.removeClass('wrapper_youtube');\r\n            elem.removeClass('wrapper_image');\r\n            elem.removeClass('wrapper_url');\r\n            if (attachment.url) {\r\n                switch(parseInt(attachment.type)) {\r\n                    case 1: //youtube\r\n                        elem.html('<iframe src=\"'+ fixEmbedUrlIfNeeded(attachment.url) +'\" class=\"preview_element\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>');\r\n                        elem.addClass('wrapper_youtube');\r\n                        elem.show();\r\n                    break;\r\n                    case 2: // image\r\n                        elem.html('<img src=\"'+ attachment.url +'\" class=\"preview_element\" alt=\"'+ attachment.info +'\"/>');\r\n                        elem.addClass('wrapper_image');\r\n                        elem.show();\r\n                    break;\r\n                    case 3: // url\r\n                        elem.html('<a href=\"'+ attachment.url +'\" class=\"preview_element\" target=\"_blank\">' + (attachment.info || attachment.url) + '</a>');\r\n                        elem.addClass('wrapper_url');\r\n                        elem.show();\r\n                    break;\r\n                    default:\r\n                        elem.html('');\r\n                        elem.hide();\r\n                }\r\n            } else {\r\n                elem.html('');\r\n                elem.hide();\r\n            }\r\n        };\r\n        \r\n        var addNote = function(columnid, ident, heading, content, attachment, owner) {\r\n            var ismynote = owner.id==userId || !ident;\r\n            var iseditable = isEditor || (ismynote && !isReadOnlyBoard);\r\n            \r\n            if (!ident) {\r\n                var pendingNote = getNote(0);\r\n                if (pendingNote) {\r\n                    pendingNote.remove();\r\n                }\r\n            }\r\n            \r\n            var note = $('<div class=\"board_note\" data-ident=\"'+ident+'\"></div>');\r\n            if (ismynote) {\r\n                note.addClass('mynote');\r\n            }\r\n            if (iseditable) {\r\n                note.addClass('editablenote');\r\n            }\r\n            \r\n            var notecontent = $('<div class=\"note_content\"></div>');\r\n            var noteHeading = $('<div class=\"note_heading\" tabindex=\"0\">' + (heading?heading:'') + '</div>');\r\n            var noteText = $('<div class=\"note_text\" tabindex=\"0\">' + (content?content:'') + '</div>');\r\n            var noteAriaText = $('<div class=\"note_ariatext hidden\" role=\"heading\" aria-level=\"4\" tabindex=\"0\"></div>');\r\n            var attachmentPreview = $('<div class=\"preview\"></div>');\r\n            if (iseditable) {\r\n                var noteAttachment = $('<div class=\"note_attachment form-group row\" tabindex=\"0\">' +\r\n                                    '<select class=\"type form-control form-control-sm '+(mediaSelection==MEDIA_SELECTION_BUTTONS?'hidden':'')+'\">' +\r\n                                        '<option value=\"0\">'+strings.option_empty+'</option>' +\r\n                                        '<option value=\"1\">'+strings.option_youtube+'</option>' +\r\n                                        '<option value=\"2\">'+strings.option_image+'</option>' +\r\n                                        '<option value=\"3\">'+strings.option_link+'</option>' +\r\n                                    '</select>' +\r\n                                    '<span class=\"type_icon fa '+(mediaSelection==MEDIA_SELECTION_DROPDOWN?'hidden':'')+'\"></span>'+\r\n                                    '<input type=\"text\" class=\"info form-control form-control-sm col-sm-12 '+(mediaSelection==MEDIA_SELECTION_BUTTONS?'with_type_icon':'')+'\" placeholder=\"\">' +\r\n                                    '<input type=\"text\" class=\"url form-control form-control-sm col-sm-12\" placeholder=\"\">' +\r\n                                '</div>'\r\n                            );\r\n                \r\n                noteAttachment.hide();\r\n            }\r\n            \r\n            notecontent.append(noteHeading);\r\n            notecontent.append(noteText);\r\n            notecontent.append(noteAriaText);\r\n            if (iseditable) {\r\n                notecontent.append(noteAttachment);\r\n            }\r\n            \r\n            notecontent.append(attachmentPreview);\r\n            note.append(notecontent);\r\n                        \r\n            if (iseditable) {\r\n                var attachmentType = noteAttachment.find('.type');\r\n                var attachmentInfo = noteAttachment.find('.info');\r\n                var attachmentUrl = noteAttachment.find('.url');\r\n                var attachmentIcon = noteAttachment.find('.type_icon');\r\n                \r\n                attachmentType.on('change', function() {\r\n                    attachmentTypeChanged(note);\r\n                    previewAttachment(note);\r\n                });\r\n                \r\n                attachmentUrl.on('change', function() {\r\n                    previewAttachment(note);\r\n                });\r\n                \r\n                attachmentInfo.on('change', function() {\r\n                    previewAttachment(note);\r\n                });\r\n                \r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    var removeAttachment = $('<div class=\"remove remove_attachment fa fa-remove\"></div>');\r\n                    removeAttachment.hide();\r\n                    removeAttachment.on('click', function() { attachmentType.val(0); attachmentType.trigger('change'); });\r\n                    noteAttachment.append(removeAttachment);\r\n                }\r\n            }\r\n            \r\n            var column_content = $('.board_column[data-ident='+columnid+'] .board_column_content');\r\n            \r\n            if (iseditable) {\r\n                var buttons = $('<div class=\"note_buttons\"></div>');\r\n                buttons.hide();\r\n                var postbutton = $('<div class=\"post_button action_button\" role=\"button\" tabindex=\"0\">'+strings.post_button_text+'</div>');\r\n                var cancelbutton = $('<div class=\"cancel_button action_button\" role=\"button\" tabindex=\"0\">'+strings.cancel_button_text+'</div>');\r\n                \r\n                buttons.append(postbutton);\r\n                buttons.append(cancelbutton);\r\n                \r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    buttons.append('<div class=\"spacer_button\"></div>');\r\n                    var ytButton = $('<div class=\"attachment_button youtube_button action_button fa '+attachmentFAIcons[0]+'\" role=\"button\" tabindex=\"0\"></div>');\r\n                    handleAction(ytButton, function() { attachmentType.val(1); attachmentType.trigger(\"change\"); });\r\n                    var imgButton = $('<div class=\"attachment_button image_button action_button fa '+attachmentFAIcons[1]+'\" role=\"button\" tabindex=\"0\"></div>');\r\n                    handleAction(imgButton, function() { attachmentType.val(2); attachmentType.trigger(\"change\"); });\r\n                    var linkButton = $('<div class=\"attachment_button link_button action_button fa '+attachmentFAIcons[2]+'\" role=\"button\" tabindex=\"0\"></div>');\r\n                    handleAction(linkButton, function() { attachmentType.val(3); attachmentType.trigger(\"change\"); });\r\n                    buttons.append(ytButton);\r\n                    buttons.append(imgButton);\r\n                    buttons.append(linkButton);\r\n                }\r\n                \r\n                note.append(buttons);\r\n                \r\n                var removeElement = $('<div class=\"remove fa fa-remove delete_note\" role=\"button\" tabindex=\"0\"></div>');\r\n                handleAction(removeElement, function() {\r\n                    deleteNote(ident);\r\n                });\r\n                \r\n                if (!ident) {\r\n                    removeElement.hide();\r\n                }\r\n                notecontent.append(removeElement);\r\n                \r\n                handleAction(cancelbutton, function() {\r\n                    stopNoteEdit();\r\n                });\r\n                \r\n                noteText.on('click', function(e) {\r\n                    if ((editingNote && editingNote==ident) || !ident) {\r\n                        noteText.editable('open');\r\n                    }\r\n                });\r\n                \r\n                var beginEdit = function() {\r\n                    startNoteEdit(ident);\r\n                };\r\n\r\n                noteHeading.on('click', function(e) {\r\n                    if ((editingNote && editingNote==ident) || !ident) {\r\n                        noteHeading.editable('open');\r\n                    }\r\n                });\r\n                \r\n                attachmentPreview.on('dblclick', beginEdit);\r\n                \r\n                handleAction(postbutton, function() {\r\n                    var sendAttach = attachmentDataForNote(note);\r\n                    \r\n                    var theHeading = noteHeading.html();\r\n                    var theText = noteText.html().substring(0, options.post_max_length);\r\n                        \r\n                    if (!ident) { // new\r\n                        serviceCall('add_note', {columnid: columnid, heading: theHeading, content: theText, attachment: sendAttach}, function(result) {\r\n                            lastHistoryId = result.historyid;\r\n                            \r\n                            note.remove();\r\n                            showNewNoteButtons();\r\n                            addNote(columnid, result.id, theHeading, theText, sendAttach, {id: userId});\r\n                            sortNotes(column_content);\r\n                            updateNoteAria(result.id);\r\n                        });\r\n                        \r\n                    } else { // update\r\n                        serviceCall('update_note', {id: ident, heading: theHeading, content: theText, attachment: sendAttach}, function(result) {\r\n                            if (result.status) {\r\n                                setAttachment(note, sendAttach);\r\n                                successNoteEdit();\r\n                                lastHistoryId = result.historyid;\r\n                                noteText.html(theText);\r\n                                updateNoteAria(ident);\r\n                            }\r\n                        });\r\n                    }\r\n                });\r\n                \r\n                handleEditableAction(noteText, beginEdit);\r\n                noteText.editable({\r\n                    toggleFontSize : false,\r\n                    closeOnEnter: false,\r\n                    callback : function( data ) {\r\n                        noteText.html(noteText.html().substring(0, options.post_max_length));\r\n                    }\r\n                });\r\n                \r\n                handleEditableAction(noteHeading, beginEdit);\r\n                noteHeading.editable({\r\n                    toggleFontSize : false,\r\n                    closeOnEnter: true\r\n                });\r\n                \r\n                setAttachment(note, attachment);\r\n            } else {\r\n                previewAttachment(note, attachment);\r\n            }\r\n            \r\n            if (ident) {\r\n                if (!noteHeading.html()) {\r\n                    noteHeading.hide();\r\n                }\r\n                var lastOne = column_content.find(\".board_note\").last();\r\n                if (lastOne.length) {\r\n                    note.insertAfter(lastOne);\r\n                } else {\r\n                    column_content.prepend(note);\r\n                }\r\n            } else {\r\n                $('.board_column[data-ident='+columnid+'] .board_column_newcontent').append(note);\r\n                updateNoteAria(ident);\r\n                noteText.editable('open'); // trigger edit of note\r\n                beginEdit();\r\n            }\r\n        };\r\n        \r\n        var addColumn = function(ident, name, notes, sort) {\r\n            var iseditable = isEditor;\r\n            var nameCache = null;\r\n            var column = $('<div class=\"board_column board_column_hasdata\" data-ident=\"'+ident+'\"></div>');\r\n            var column_header = $('<div class=\"board_column_header\"></div>');\r\n            var column_sort = $('<div class=\"column_sort fa\"></div>');\r\n            var column_name = $('<div class=\"column_name\" tabindex=\"0\" aria-level=\"3\" role=\"heading\">'+name+'</div>');\r\n            var column_content = $('<div class=\"board_column_content\"></div>');\r\n            var column_newcontent = $('<div class=\"board_column_newcontent\"></div>');\r\n            column_header.append(column_sort);\r\n            column_header.append(column_name);\r\n            \r\n            column_sort.on('click', function() {\r\n                sortNotes(column_content, true);\r\n            });\r\n            \r\n            if (iseditable) {\r\n                column.addClass('editablecolumn');\r\n\r\n                var removeElement = $('<div class=\"remove fa fa-remove delete_column\" role=\"button\" tabindex=\"0\"></div>');\r\n                handleAction(removeElement, function() {\r\n                    if (confirm(strings.remove_column_text)) {\r\n                        serviceCall('delete_column', {id: ident}, function(result) {\r\n                            if (result.status) {\r\n                                column.remove();\r\n                                lastHistoryId = result.historyid;\r\n                            }\r\n                        });\r\n                    }\r\n                });\r\n                \r\n                column_header.append(removeElement);\r\n            }\r\n            \r\n            column.append(column_header);\r\n            column.append(column_content);\r\n            column.append(column_newcontent);\r\n            \r\n            if (iseditable) {\r\n                handleEditableAction(column_name, function() {\r\n                    nameCache = column_name.html();\r\n                }, true);\r\n                \r\n                column_name.editable({\r\n                    toggleFontSize : false,\r\n                    closeOnEnter: true,\r\n                    callback : function( data ) {\r\n                        if ( data.content ) {\r\n                            serviceCall('update_column', {id: ident, name: column_name.html()}, function(result) {\r\n                                if (!result.status) {\r\n                                    column_name.html(nameCache);\r\n                                    nameCache = null;\r\n                                } else {\r\n                                    lastHistoryId = result.historyid;\r\n                                    updateColumnAria(ident);\r\n                                }\r\n                            }, function() {\r\n                                column_name.html(nameCache);\r\n                                nameCache = null;\r\n                            });\r\n                        } else {\r\n                            column_name.html(nameCache);\r\n                            nameCache = null;\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n\r\n            if (!isReadOnlyBoard) {\r\n                column_newcontent.append('<div class=\"board_button newnote\" role=\"button\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa '+options.noteicon+'\"></span></div></div>');\r\n                \r\n                handleAction(column_newcontent.find('.newnote'), function() {\r\n                    addNote(ident, 0, null, null, null, {id: userId});\r\n                });\r\n            }\r\n\r\n            var lastOne = $(\".mod_board .board_column_hasdata\").last();\r\n            if (lastOne.length) {\r\n                column.insertAfter(lastOne);\r\n            } else {\r\n                $(\".mod_board\").append(column);\r\n            }\r\n                        \r\n            if (notes) {\r\n                for (index in notes) {\r\n                    addNote(ident, notes[index].id, notes[index].heading, notes[index].content, {type: notes[index].type, info: notes[index].info, url: notes[index].url}, {id: notes[index].userid});\r\n                }\r\n            }\r\n            sortNotes(column_content, true);\r\n            updateColumnAria(ident);\r\n        };\r\n        \r\n        var addNewColumnButton = function() {\r\n            var column = $('<div class=\"board_column board_column_empty\"></div>');\r\n            var newBusy = false;\r\n            column.append('<div class=\"board_button newcolumn\" role=\"button\" tabindex=\"0\" aria-label=\"'+strings.aria_newcolumn+'\"><div class=\"button_content\"><span class=\"fa '+options.columnicon+'\"></span></div></div>');\r\n            \r\n            handleAction(column.find('.newcolumn'), function() {\r\n                if (newBusy) {\r\n                    return;\r\n                }\r\n                newBusy = true;\r\n                \r\n                serviceCall('add_column', {boardid: board.id, name: strings.default_column_heading}, function(result) {\r\n                    addColumn(result.id, strings.default_column_heading);\r\n                    lastHistoryId = result.historyid;\r\n                    newBusy = false;\r\n                }, function(error) {\r\n                    newBusy = false;\r\n                });\r\n            });\r\n            \r\n            $(\".mod_board\").append(column);\r\n        };\r\n        \r\n        var processBoardHistory = function() {\r\n            serviceCall('board_history', {id: board.id, since: lastHistoryId}, function(boardhistory) {\r\n                for (index in boardhistory) {\r\n                    var item = boardhistory[index];\r\n                    if (item.boardid!=board.id) {\r\n                        continue; // hmm\r\n                    }\r\n                    \r\n                    var data = JSON.parse(item.content);\r\n                    if (item.action=='add_note') {\r\n                        addNote(data.columnid, data.id, data.heading, data.content, data.attachment, {id: item.userid});\r\n                        updateNoteAria(data.id);\r\n                    } else if (item.action=='update_note') {\r\n                        var note = getNote(data.id);\r\n                        if (note) {\r\n                            var heading = getNoteHeadingForNote(note);\r\n                            \r\n                            var updateNote = function() {\r\n                                heading.html(data.heading);\r\n                                if (data.heading) {\r\n                                    heading.show();\r\n                                } else {\r\n                                    heading.hide();\r\n                                }\r\n                                getNoteTextForNote(note).html(data.content);\r\n                                setAttachment(note, data.attachment);\r\n                                noteTextCache = null;\r\n                                noteHeadingCache = null;\r\n                                attachmentCache = null;\r\n                                updateNoteAria(data.id);\r\n                            };\r\n                            \r\n                            if (editingNote==data.id) {\r\n                                Notification.confirm(\r\n                                    strings.note_changed_text.split(\"\\n\")[0], // Confirm.\r\n                                    strings.note_changed_text.split(\"\\n\")[1], // Are you sure?\r\n                                    strings.Ok,\r\n                                    strings.Cancel,\r\n                                    function() {\r\n                                        if (editingNote==data.id) {\r\n                                            updateNote();\r\n                                        }\r\n                                        stopNoteEdit();\r\n                                    }\r\n                                );\r\n                            } else {\r\n                                updateNote();\r\n                            }\r\n                        }\r\n                    } else if (item.action=='delete_note') {\r\n                        if (editingNote==data.id) {\r\n                            Notification.alert(strings.warning, strings.note_deleted_text);\r\n                            stopNoteEdit();\r\n                        }\r\n                        getNote(data.id).remove();\r\n                        \r\n                    } else if (item.action=='add_column') {\r\n                        addColumn(data.id, data.name);\r\n                    } else if (item.action=='update_column') {\r\n                        $(\".board_column[data-ident='\"+data.id+\"'] .column_name\").html(data.name);\r\n                        updateColumnAria(data.id);\r\n                    } else if (item.action=='delete_column') {\r\n                        var column = $(\".board_column[data-ident='\"+data.id+\"']\");\r\n                        if (editingNote && column.find('.board_note[data-ident=\"'+editingNote+'\"]').length) {\r\n                            stopNoteEdit();\r\n                        }\r\n                        column.remove();\r\n                    }\r\n                    lastHistoryId = item.id;\r\n                }\r\n                \r\n                updateBoard();\r\n            });\r\n        };\r\n        \r\n        var updateBoard = function(instant) {\r\n            if (instant) {\r\n                processBoardHistory();\r\n            } else {\r\n                if (reloadTimer) {\r\n                    stopUpdating();\r\n                }\r\n                reloadTimer = setTimeout(processBoardHistory, 2000);\r\n            }\r\n        };\r\n        \r\n        var stopUpdating = function() {\r\n            clearTimeout(reloadTimer);\r\n            reloadTimer = null;\r\n        };\r\n        \r\n        var sortNotes = function(content, toggle) {\r\n            var sort_col = $(content).parent().find('.column_sort');\r\n            var direction = $(content).data('sort');\r\n            if (toggle) {\r\n                direction = direction=='asc'?'desc':'asc';\r\n            }\r\n            \r\n            if (direction=='asc') {\r\n                sort_col.removeClass('fa-angle-down');\r\n                sort_col.addClass('fa-angle-up');\r\n            } else {\r\n                sort_col.removeClass('fa-angle-up');\r\n                sort_col.addClass('fa-angle-down');\r\n            }\r\n            $(content).data('sort', direction);\r\n            \r\n            $('> .board_note', $(content)).sort(direction=='asc'?asc:desc).appendTo($(content));\r\n            function desc(a, b) { return $(b).data(\"ident\") < $(a).data(\"ident\") ? -1 : 1; }\r\n            function asc(a, b) { return $(b).data(\"ident\") < $(a).data(\"ident\") ? 1 : -1; }\r\n        };\r\n        \r\n        var init = function() {\r\n            serviceCall('get_board', {id: board.id}, function(columns) {\r\n                // init\r\n                if (columns) {\r\n                    for (index in columns) {\r\n                        addColumn(columns[index].id, columns[index].name, columns[index].notes || {});\r\n                    }\r\n                }\r\n                if (isEditor) {\r\n                    addNewColumnButton();\r\n                }\r\n                \r\n                lastHistoryId = board.historyid;\r\n            });\r\n        };\r\n   \r\n        // get strings\r\n        var stringsInfo = [];\r\n        for (string in strings) {\r\n            stringsInfo.push({key: string, component: 'mod_board'});\r\n        }\r\n                \r\n        $.when(Str.get_strings(stringsInfo)).done(function(results) {\r\n            var index = 0;\r\n            for (string in strings) {\r\n                strings[string] = results[index++];\r\n            }\r\n            \r\n            init();\r\n        });\r\n    };\r\n});"],"file":"board.min.js"}