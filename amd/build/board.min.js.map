{"version":3,"sources":["../src/board.js"],"names":["define","$","jqui","Str","Ajax","Notification","_serviceCall","method","args","callback","failcallback","call","methodname","done","data","bind","fail","error","exception","isAriaTriggerKey","key","encodeText","rawText","text","html","decodeText","encodedText","handleAction","elem","on","e","type","keyCode","preventDefault","handleEditableAction","callBeforeOnKeyEditing","is","Error","editable","board","options","strings","default_column_heading","post_button_text","cancel_button_text","remove_note_text","remove_column_text","note_changed_text","note_deleted_text","rate_note_text","Ok","Cancel","warning","option_youtube","option_youtube_info","option_youtube_url","option_image","option_image_info","option_image_url","option_link","option_link_info","option_link_url","option_empty","aria_newcolumn","aria_newpost","aria_deletecolumn","aria_deletepost","aria_addmedia","aria_addmedianew","aria_deleteattachment","aria_postedit","aria_canceledit","aria_postnew","aria_cancelnew","aria_choosefilenew","aria_choosefileedit","aria_ratepost","choose_file","invalid_file_extension","invalid_file_size_min","invalid_file_size_max","MEDIA_SELECTION_BUTTONS","ATTACHMENT_VIDEO","ATTACHMENT_IMAGE","ATTACHMENT_LINK","SORTBY_DATE","SORTBY_RATING","reloadTimer","lastHistoryId","isEditor","userId","mediaSelection","mediaselection","noteTextCache","noteHeadingCache","attachmentCache","editingNote","isReadOnlyBoard","readonly","accepted_file_extensions","file","extensions","accepted_file_size_min","size_min","accepted_file_size_max","size_max","ratingenabled","sortby","serviceCall","stopUpdating","apply","arguments","updateBoard","getNote","ident","getNoteText","getNoteTextForNote","note","find","getNoteHeading","getNoteHeadingForNote","getNoteButtonsForNote","showNewNoteButtons","show","hideNewNoteButtons","hide","getNoteAttachmentsForNote","textIdentifierForNote","noteText","noteHeading","noteAttachment","attachmentDataForNote","length","replace","split","slice","join","info","updateNoteAria","noteId","columnIdentifier","closest","post_button","cancel_button","add_youtube","add_image","add_link","remove_attachment","choose_file_button","noteIdentifier","attr","attRemove","updateColumnAria","columnId","column","each","index","successNoteEdit","stopNoteEdit","remove","setAttachment","previewAttachment","startNoteEdit","pendingNote","deleteNote","confirm","id","result","status","historyid","rateNote","rating","canrate","sortNotes","attachmentTypeChanged","val","attachmentInfo","attachmentUrl","attachmentFile","attachmentIcon","removeAttachment","prop","attachmentTypeToString","FileReader","removeClass","addClass","attachmentFAIcon","attachment","attType","url","filename","filecontents","fileElem","attachmentFAIcons","preloadFile","indexOf","name","pop","toLowerCase","alert","size","fr","onload","readAsDataURL","fixEmbedUrlIfNeeded","parseInt","addNote","columnid","heading","content","owner","sortorder","ismynote","iseditable","notecontent","noteAriaText","attachmentPreview","append","attachmentType","attachmentFileInput","trigger","column_content","buttons","postbutton","cancelbutton","ytButton","imgButton","linkButton","removeElement","beginEdit","sendAttach","theHeading","theText","substring","post_max_length","userid","timecreated","toggleFontSize","closeOnEnter","rateElement","lastOne","last","insertAfter","prepend","addColumn","notes","nameCache","column_header","column_sort","column_name","column_newcontent","hideheaders","noteicon","updateSortable","addNewColumnButton","newBusy","columnicon","boardid","processBoardHistory","since","boardhistory","item","JSON","parse","action","updateNote","instant","history_refresh","setTimeout","clearTimeout","toggle","sort_col","parent","direction","desc","a","b","asc","sort","appendTo","sortable","connectWith","stop","ui","tocolumn","init","columns","stringsInfo","string","push","component","when","get_strings","results"],"mappings":"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","sourcesContent":["define(['jquery', 'jqueryui', 'core/str', 'core/ajax', 'core/notification', 'core/templates', 'mod_board/jquery.editable.amd'], function($, jqui, Str, Ajax, Notification, Templates) {\r\n    \r\n    var _serviceCall = function(method, args, callback, failcallback) {\r\n        Ajax.call([{\r\n            methodname: 'mod_board_' + method,\r\n            args: args,\r\n            done: function(data) {\r\n                callback(data);\r\n            }.bind(this),\r\n            fail: function(error) {\r\n                Notification.exception(error);\r\n                if (failcallback) {\r\n                    failcallback(error);\r\n                }\r\n            }\r\n        }]);\r\n    };\r\n    \r\n    var isAriaTriggerKey = function(key) {\r\n        return key==13 || key==32;\r\n    };\r\n    \r\n    var encodeText = function(rawText) {\r\n        return $('<div />').text(rawText).html();\r\n    };\r\n    \r\n    var decodeText = function(encodedText) {\r\n        return $('<div />').html(encodedText).text();\r\n    };\r\n    \r\n    var handleAction = function(elem, callback) {\r\n        return elem.on('click keypress', function(e) {\r\n            if (e.type=='keypress') {\r\n                if (isAriaTriggerKey(e.keyCode)) {\r\n                    e.preventDefault();\r\n                } else {\r\n                    return;\r\n                }\r\n            }\r\n            \r\n            callback();\r\n        });\r\n    };\r\n    \r\n    var handleEditableAction = function(elem, callback, callBeforeOnKeyEditing) {\r\n        if (elem.is(':editable')) {\r\n            throw new Error('handleEditableAction - must be called before setting the element as editable');\r\n        }\r\n        \r\n        // can't use on(edit) here because we want to do actions (save cache) before the control goes into edit mode\r\n        return elem.on('dblclick keypress', function(e) {\r\n            if (e.type=='keypress') {\r\n                if (isAriaTriggerKey(e.keyCode) && !elem.is(':editing')) {\r\n                    e.preventDefault();\r\n                    if (callBeforeOnKeyEditing) {\r\n                        callback();\r\n                    }\r\n                    elem.editable('open');\r\n                    if (callBeforeOnKeyEditing) {\r\n                        return;\r\n                    }\r\n                } else {\r\n                    return;\r\n                }\r\n            }\r\n            \r\n            callback();\r\n        });\r\n    };\r\n        \r\n    return function(board, options) {\r\n        var strings = {\r\n            default_column_heading: '',\r\n            post_button_text: '',\r\n            cancel_button_text: '',\r\n            remove_note_text: '',\r\n            remove_column_text: '',\r\n            note_changed_text: '',\r\n            note_deleted_text: '',\r\n            rate_note_text: '',\r\n            Ok: '',\r\n            Cancel: '',\r\n            warning: '',\r\n            option_youtube: '',\r\n            option_youtube_info: '',\r\n            option_youtube_url: '',\r\n            option_image: '',\r\n            option_image_info: '',\r\n            option_image_url: '',\r\n            option_link: '',\r\n            option_link_info: '',\r\n            option_link_url: '',\r\n            option_empty: '',\r\n            \r\n            aria_newcolumn: '',\r\n            aria_newpost: '',\r\n            aria_deletecolumn: '',\r\n            aria_deletepost: '',\r\n            aria_addmedia: '',\r\n            aria_addmedianew: '',\r\n            aria_deleteattachment: '',\r\n            aria_postedit: '',\r\n            aria_canceledit: '',\r\n            aria_postnew: '',\r\n            aria_cancelnew: '',\r\n            aria_choosefilenew: '',\r\n            aria_choosefileedit: '',\r\n            aria_ratepost: '',\r\n            \r\n            choose_file: '',\r\n            invalid_file_extension: '',\r\n            invalid_file_size_min: '',\r\n            invalid_file_size_max: '',\r\n        };\r\n        \r\n        const MEDIA_SELECTION_BUTTONS = 1;\r\n        const MEDIA_SELECTION_DROPDOWN = 2;\r\n        const ATTACHMENT_VIDEO = 1;\r\n        const ATTACHMENT_IMAGE = 2;\r\n        const ATTACHMENT_LINK = 3;\r\n        const SORTBY_DATE = 1;\r\n        const SORTBY_RATING = 2;\r\n        var reloadTimer = null;\r\n        var lastHistoryId = null;\r\n        var isEditor = options.isEditor || false;\r\n        var userId = options.userId || -1;\r\n        var mediaSelection = options.mediaselection || MEDIA_SELECTION_BUTTONS;\r\n        var noteTextCache = null, noteHeadingCache = null, attachmentCache = null;\r\n        var editingNote = 0;\r\n        var isReadOnlyBoard = options.readonly || false;\r\n        var accepted_file_extensions = options.file.extensions;\r\n        var accepted_file_size_min = options.file.size_min;\r\n        var accepted_file_size_max = options.file.size_max;\r\n        var ratingenabled = options.ratingenabled;\r\n        var sortby = options.sortby || SORTBY_DATE;\r\n        \r\n        var serviceCall = function(method, args, callback, failcallback) {\r\n            if (method!=='board_history') {\r\n                stopUpdating();\r\n            }\r\n            _serviceCall(method, args, function() {\r\n                callback.apply(null, arguments);\r\n                if (method!=='board_history' && method!='get_board') {\r\n                    updateBoard(true);\r\n                }\r\n            }, failcallback);\r\n        };\r\n        \r\n        var getNote = function(ident) {\r\n            return $(\".board_note[data-ident='\"+ident+\"']\");\r\n        };\r\n        \r\n        var getNoteText = function(ident) {\r\n            return $(\".board_note[data-ident='\"+ident+\"'] .note_text\");\r\n        };\r\n        \r\n        var getNoteTextForNote = function(note) {\r\n            return $(note).find(\".note_text\");\r\n        };\r\n        \r\n        var getNoteHeading = function(ident) {\r\n            return $(\".board_note[data-ident='\"+ident+\"'] .note_heading\");\r\n        };\r\n        \r\n        var getNoteHeadingForNote = function(note) {\r\n            return $(note).find(\".note_heading\");\r\n        };\r\n        \r\n        var getNoteButtonsForNote = function(note) {\r\n            return $(note).find(\".note_buttons\");\r\n        };\r\n        \r\n        var showNewNoteButtons = function() {\r\n            $('.board_column .board_column_newcontent .board_button.newnote').show();\r\n        };\r\n        \r\n        var hideNewNoteButtons = function() {\r\n            $('.board_column .board_column_newcontent .board_button.newnote').hide();\r\n        };\r\n        \r\n        var getNoteAttachmentsForNote = function(note) {\r\n            return $(note).find(\".note_attachment\");\r\n        };\r\n        \r\n        var textIdentifierForNote = function(note) {\r\n            var noteText = getNoteTextForNote(note).html();\r\n            var noteHeading = getNoteHeadingForNote(note).html();\r\n            var noteAttachment = attachmentDataForNote(note);\r\n            \r\n            if (noteHeading.length>0) {\r\n                return noteHeading;\r\n            }\r\n            if (noteText.length>0) {\r\n                return noteText.replace(/<br\\s*\\/?>/gi,\" \").replace(/\\n/g, \" \").split(/\\s+/).slice(0,5).join(\" \");\r\n            }\r\n            if (noteAttachment.info && noteAttachment.info.length>0) {\r\n                return noteAttachment.info;\r\n            }\r\n            return null;\r\n        };\r\n        \r\n        var updateNoteAria = function(noteId) {\r\n            var note = getNote(noteId);\r\n            var columnIdentifier = note.closest('.board_column').find('.column_name').text();\r\n            var post_button = cancel_button = add_youtube = add_image = add_link = remove_attachment = choose_file_button = \"\";\r\n            \r\n            if (!noteId) { // new post\r\n                post_button = strings.aria_postnew.replace('{column}', columnIdentifier);\r\n                cancel_button = strings.aria_cancelnew.replace('{column}', columnIdentifier);\r\n                add_youtube = strings.aria_addmedianew.replace('{type}', strings.option_youtube).replace('{column}', columnIdentifier);\r\n                add_image = strings.aria_addmedianew.replace('{type}', strings.option_image).replace('{column}', columnIdentifier);\r\n                add_link = strings.aria_addmedianew.replace('{type}', strings.option_link).replace('{column}', columnIdentifier);\r\n                choose_file_button = strings.aria_choosefilenew.replace('{column}', strings.columnIdentifier);\r\n            } else {\r\n                var noteIdentifier = textIdentifierForNote(note);\r\n                \r\n                post_button = strings.aria_postedit.replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\r\n                cancel_button = strings.aria_canceledit.replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\r\n                add_youtube = strings.aria_addmedia.replace('{type}', strings.option_youtube).replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\r\n                add_image = strings.aria_addmedia.replace('{type}', strings.option_image).replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\r\n                add_link = strings.aria_addmedia.replace('{type}', strings.option_link).replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\r\n                remove_attachment = strings.aria_deleteattachment.replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\r\n                choose_file_button = strings.aria_choosefileedit.replace('{column}', columnIdentifier).replace('{post}', noteIdentifier);\r\n                \r\n                note.find('.delete_note').attr('aria-label', strings.aria_deletepost.replace('{column}', columnIdentifier).replace('{post}', noteIdentifier));\r\n                note.find('.rating').attr('aria-label', strings.aria_ratepost.replace('{column}', columnIdentifier).replace('{post}', noteIdentifier));\r\n                note.find('.note_ariatext').html(noteIdentifier);\r\n            }\r\n            \r\n            if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                if (noteId) {\r\n                    var attRemove = note.find('.remove_attachment');\r\n                    if (attRemove) {\r\n                        attRemove.attr('aria-label', remove_attachment);\r\n                    }\r\n                }\r\n                \r\n                note.find('.attachment_button.youtube_button').attr('aria-label', add_youtube);\r\n                note.find('.attachment_button.image_button').attr('aria-label', add_image);\r\n                note.find('.attachment_button.link_button').attr('aria-label', add_link);\r\n            }\r\n            note.find('.post_button').attr('aria-label', post_button);\r\n            note.find('.cancel_button').attr('aria-label', cancel_button);\r\n            note.find('.choose_file_button').attr('aria-label', choose_file_button);\r\n        };\r\n        \r\n        var updateColumnAria = function(columnId) {\r\n            var column = $('.board_column[data-ident='+columnId+']');\r\n            var columnIdentifier = column.find('.column_name').text();\r\n            column.find('.newnote').attr('aria-label', strings.aria_newpost.replace('{column}', columnIdentifier));\r\n            column.find('.delete_column').attr('aria-label', strings.aria_deletecolumn.replace('{column}', columnIdentifier));\r\n            \r\n            column.find(\".board_note\").each(function(index, note) {\r\n                updateNoteAria($(note).data('ident'));\r\n            });\r\n        };\r\n        \r\n        var successNoteEdit = function() {\r\n            noteTextCache = null;\r\n            noteHeadingCache = null;\r\n            attachmentCache = null;\r\n            stopNoteEdit();\r\n        };\r\n        \r\n        var stopNoteEdit = function() {\r\n            if (!editingNote) {\r\n                getNote(0).remove();\r\n                showNewNoteButtons();\r\n                return;\r\n            }\r\n            \r\n            if (noteTextCache) {\r\n                getNoteText(editingNote).html(noteTextCache);\r\n                noteTextCache = null;\r\n            }\r\n            \r\n            if (noteHeadingCache) {\r\n                getNoteHeading(editingNote).html(noteHeadingCache);\r\n                noteHeadingCache = null;\r\n            }\r\n            \r\n            var note = getNote(editingNote);\r\n            \r\n            if (note) {\r\n                if (attachmentCache) {\r\n                    setAttachment(note, attachmentCache);\r\n                    attachmentCache = null;\r\n                } else {\r\n                    previewAttachment(note);\r\n                }\r\n\r\n                getNoteButtonsForNote(note).hide();\r\n                getNoteAttachmentsForNote(note).hide();\r\n                showNewNoteButtons();\r\n                var noteHeading = getNoteHeadingForNote(note);\r\n                if (!noteHeading.html()) {\r\n                    noteHeading.hide();\r\n                }\r\n            }\r\n            \r\n            editingNote = 0;\r\n        };\r\n        \r\n        var startNoteEdit = function(ident) {\r\n            if (editingNote) {\r\n                if (editingNote==ident) {\r\n                    return;\r\n                }\r\n                stopNoteEdit();\r\n            }\r\n            \r\n            if (ident) {\r\n                var pendingNote = getNote(0);\r\n                if (pendingNote) {\r\n                    pendingNote.remove();\r\n                }\r\n            }\r\n            \r\n            var note = getNote(ident);\r\n            if (note) {\r\n                getNoteButtonsForNote(note).show();\r\n                getNoteAttachmentsForNote(note).show();\r\n                hideNewNoteButtons();\r\n                \r\n                var noteHeading = getNoteHeadingForNote(note);\r\n                if (ident) {\r\n                    attachmentCache = attachmentDataForNote(note);\r\n                    noteTextCache = getNoteTextForNote(note).html();\r\n                    noteHeadingCache = noteHeading.html();\r\n                    editingNote = ident;\r\n                }\r\n                noteHeading.show();\r\n            }\r\n        };\r\n        \r\n        var deleteNote = function(ident) {\r\n            if (confirm(strings.remove_note_text)) {\r\n                serviceCall('delete_note', {id: ident}, function(result) {\r\n                    if (result.status) {\r\n                        lastHistoryId = result.historyid;\r\n                        getNote(ident).remove();\r\n                    }\r\n                });\r\n            }\r\n        };\r\n        \r\n        var rateNote = function(ident) {\r\n            if (!ratingenabled) return;\r\n            if (isReadOnlyBoard) return;\r\n            \r\n            var note = getNote(ident);\r\n            var rating = note.find('.rating');\r\n            if (rating.data('disabled')) {\r\n                return;\r\n            }\r\n            rating.data('disabled', true);\r\n            \r\n            serviceCall('can_rate_note', {id: ident}, function(canrate) {\r\n                if (canrate) {\r\n                    if (confirm(strings.rate_note_text)) {\r\n                        serviceCall('rate_note', {id: ident}, function(result) {\r\n                            if (result.status) {\r\n                                lastHistoryId = result.historyid;\r\n                                rating.html(result.rating);\r\n                                if (sortby==SORTBY_RATING) {\r\n                                    sortNotes(note.closest('.board_column_content'));\r\n                                }\r\n                            }\r\n                            rating.data('disabled', false);\r\n                        });\r\n                    }\r\n                }\r\n            });\r\n        };\r\n        \r\n        var attachmentTypeChanged = function(note) {\r\n            var noteAttachment = getNoteAttachmentsForNote(note);\r\n            var type = noteAttachment.find('.type').val();\r\n            \r\n            var attachmentInfo = noteAttachment.find('.info');\r\n            var attachmentUrl = noteAttachment.find('.url');\r\n            var attachmentFile = noteAttachment.find('.file');\r\n            \r\n            if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                var attachmentIcon = noteAttachment.find('.type_icon');\r\n                var removeAttachment = noteAttachment.find('.remove_attachment');\r\n            } else {\r\n                getNoteButtonsForNote(note).find('.attachment_button').hide();\r\n            }\r\n                \r\n            if (type>\"0\") {\r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    removeAttachment.show();\r\n                }\r\n                attachmentInfo.prop('placeholder', strings['option_'+attachmentTypeToString(type)+'_info']);\r\n                attachmentUrl.prop('placeholder', strings['option_'+attachmentTypeToString(type)+'_url']);\r\n                \r\n                attachmentInfo.show();\r\n                if (type==ATTACHMENT_IMAGE && FileReader) {\r\n                    attachmentFile.show();\r\n                    attachmentUrl.hide();\r\n                } else {\r\n                    attachmentFile.hide();\r\n                    attachmentUrl.show();\r\n                }\r\n                \r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    attachmentIcon.removeClass().addClass(['type_icon', 'fa', attachmentFAIcon(type)]);\r\n                    attachmentIcon.show();\r\n                    getNoteButtonsForNote(note).find('.attachment_button').hide();\r\n                }\r\n            } else {\r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    removeAttachment.hide();\r\n                }\r\n                attachmentInfo.hide();\r\n                attachmentUrl.hide();\r\n                attachmentFile.hide();\r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    attachmentIcon.hide();\r\n                }\r\n                attachmentInfo.val('');\r\n                attachmentUrl.val('');\r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    getNoteButtonsForNote(note).find('.attachment_button').show();\r\n                }\r\n            }\r\n        }\r\n        \r\n        var setAttachment = function(note, attachment) {\r\n            var noteAttachment = getNoteAttachmentsForNote(note);\r\n            if (noteAttachment) {\r\n                if (!attachment) {\r\n                    attachment = {type: \"0\"};\r\n                } else {\r\n                    attachment.type += \"\";//just in case\r\n                }\r\n                var attType = noteAttachment.find('.type');\r\n                attType.val(attachment.type?attachment.type: \"0\");\r\n                if (attType.val()>\"0\") {\r\n                    noteAttachment.find('.info').val(decodeText(attachment.info));\r\n                    noteAttachment.find('.url').val(decodeText(attachment.url));\r\n                }\r\n                attachmentTypeChanged(note, attachment);\r\n            }\r\n            previewAttachment(note, attachment);\r\n        };\r\n        \r\n        var attachmentDataForNote = function(note) {\r\n            var attachment = { type: 0, info: null, url: null, filename: null, filecontents: null };\r\n            var noteAttachment = getNoteAttachmentsForNote(note);\r\n            if (noteAttachment.length) {\r\n                attachment.type = noteAttachment.find('.type').val();\r\n                attachment.info = encodeText(noteAttachment.find('.info').val());\r\n                attachment.url = encodeText(noteAttachment.find('.url').val());\r\n                var fileElem = noteAttachment.find('.file>input');\r\n                if (fileElem.data('filename')) {\r\n                    attachment.filename = fileElem.data('filename');\r\n                    attachment.filecontents = fileElem.data('filecontents');\r\n                }\r\n            }\r\n            if ((!attachment.info || !attachment.info.length) && (!attachment.url || !attachment.url.length) && (!attachment.filename)) {\r\n                attachment.type = 0;\r\n            }\r\n            \r\n            return attachment;\r\n        };\r\n        \r\n        var attachmentTypeToString = function(type) {\r\n            switch(type) {\r\n                case \"1\": return 'youtube';\r\n                case \"2\": return 'image';\r\n                case \"3\": return 'link';\r\n                default: return null;\r\n            }\r\n        };\r\n        \r\n        var attachmentFAIcons = ['fa-youtube', 'fa-picture-o', 'fa-link'];\r\n        var attachmentFAIcon = function(type) {\r\n            return attachmentFAIcons[type-1] || null;\r\n        }\r\n        \r\n        var preloadFile = function(note, callback) {\r\n            var noteAttachment = getNoteAttachmentsForNote(note);\r\n            if (noteAttachment.length) {\r\n                var fileElem = noteAttachment.find('.file>input');\r\n                if (FileReader && fileElem.prop('files').length) {\r\n                    var file = fileElem.prop('files')[0];\r\n                    if (accepted_file_extensions.indexOf(file.name.split('.').pop().toLowerCase())==-1) { // wrong exception\r\n                        Notification.alert(strings.warning, strings.invalid_file_extension);\r\n                    } else if (file.size < accepted_file_size_min) {\r\n                        Notification.alert(strings.warning, strings.invalid_file_size_min);\r\n                    } else if (file.size > accepted_file_size_max) {\r\n                        Notification.alert(strings.warning, strings.invalid_file_size_max);\r\n                    } else {\r\n                        fileElem.data('filename', file.name);\r\n                        var fr = new FileReader();\r\n                        fr.onload = function() {\r\n                            fileElem.data('filecontents', fr.result);\r\n                            callback();\r\n                            fileElem.val('');\r\n                        };\r\n                        fr.readAsDataURL(file);\r\n                    }\r\n                } else {\r\n                    callback();\r\n                }\r\n            } else {\r\n                callback();\r\n            }\r\n        }\r\n        \r\n        var previewAttachment = function(note, attachment) {\r\n            var elem = note.find('.preview');\r\n            if (!attachment) {\r\n                attachment = attachmentDataForNote(note);\r\n            }\r\n            var fixEmbedUrlIfNeeded = function(url) {\r\n                return url.replace(/watch\\?v=/gi, '/embed/').replace(/youtu\\.be/, 'youtube.com/embed');\r\n            };\r\n            \r\n            if (!getNoteTextForNote(note).html().length) {\r\n                elem.addClass('notext');\r\n            } else {\r\n                elem.removeClass('notext');\r\n            }\r\n            \r\n            elem.removeClass('wrapper_youtube');\r\n            elem.removeClass('wrapper_image');\r\n            elem.removeClass('wrapper_url');\r\n            if (attachment.filename && parseInt(attachment.type)==ATTACHMENT_IMAGE) { //before uploading\r\n                elem.html('<img src=\"'+ attachment.filecontents +'\" class=\"preview_element\" alt=\"'+ attachment.info +'\"/>');\r\n                elem.addClass('wrapper_image');\r\n                elem.show();\r\n            }\r\n            else if (attachment.url) {\r\n                switch(parseInt(attachment.type)) {\r\n                    case ATTACHMENT_VIDEO: //youtube\r\n                        elem.html('<iframe src=\"'+ fixEmbedUrlIfNeeded(attachment.url) +'\" class=\"preview_element\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>');\r\n                        elem.addClass('wrapper_youtube');\r\n                        elem.show();\r\n                    break;\r\n                    case ATTACHMENT_IMAGE: // image\r\n                        elem.html('<img src=\"'+ attachment.url +'\" class=\"preview_element\" alt=\"'+ attachment.info +'\"/>');\r\n                        elem.addClass('wrapper_image');\r\n                        elem.show();\r\n                    break;\r\n                    case ATTACHMENT_LINK: // url\r\n                        elem.html('<a href=\"'+ attachment.url +'\" class=\"preview_element\" target=\"_blank\">' + (attachment.info || attachment.url) + '</a>');\r\n                        elem.addClass('wrapper_url');\r\n                        elem.show();\r\n                    break;\r\n                    default:\r\n                        elem.html('');\r\n                        elem.hide();\r\n                }\r\n            } else {\r\n                elem.html('');\r\n                elem.hide();\r\n            }\r\n        };\r\n        \r\n        var addNote = function(columnid, ident, heading, content, attachment, owner, sortorder, rating) {\r\n            var ismynote = owner.id==userId || !ident;\r\n            var iseditable = isEditor || (ismynote && !isReadOnlyBoard);\r\n            \r\n            if (!ident) {\r\n                var pendingNote = getNote(0);\r\n                if (pendingNote) {\r\n                    pendingNote.remove();\r\n                }\r\n            }\r\n            \r\n            var note = $('<div class=\"board_note\" data-ident=\"'+ident+'\" data-sortorder=\"'+sortorder+'\"></div>');\r\n            if (ismynote) {\r\n                note.addClass('mynote');\r\n            }\r\n            if (iseditable) {\r\n                note.addClass('editablenote');\r\n            }\r\n            \r\n            var notecontent = $('<div class=\"note_content\"></div>');\r\n            var noteHeading = $('<div class=\"note_heading\" tabindex=\"0\">'+(heading?heading:'')+'</div>');\r\n            var noteText = $('<div class=\"note_text\" tabindex=\"0\">'+(content?content:'')+'</div>');\r\n            var noteAriaText = $('<div class=\"note_ariatext hidden\" role=\"heading\" aria-level=\"4\" tabindex=\"0\"></div>');\r\n            var attachmentPreview = $('<div class=\"preview\"></div>');\r\n            if (iseditable) {\r\n                var noteAttachment = $('<div class=\"note_attachment form-group row\" tabindex=\"0\">' +\r\n                                    '<select class=\"type form-control form-control-sm '+(mediaSelection==MEDIA_SELECTION_BUTTONS?'hidden':'')+'\">' +\r\n                                        '<option value=\"0\">'+strings.option_empty+'</option>' +\r\n                                        '<option value=\"'+ATTACHMENT_VIDEO+'\">'+strings.option_youtube+'</option>' +\r\n                                        '<option value=\"'+ATTACHMENT_IMAGE+'\">'+strings.option_image+'</option>' +\r\n                                        '<option value=\"'+ATTACHMENT_LINK+'\">'+strings.option_link+'</option>' +\r\n                                    '</select>' +\r\n                                    '<span class=\"type_icon fa '+(mediaSelection==MEDIA_SELECTION_DROPDOWN?'hidden':'')+'\"></span>'+\r\n                                    '<input type=\"text\" class=\"info form-control form-control-sm col-sm-12 '+(mediaSelection==MEDIA_SELECTION_BUTTONS?'with_type_icon':'')+'\" placeholder=\"\">' +\r\n                                    '<input type=\"text\" class=\"url form-control form-control-sm col-sm-12\" placeholder=\"\">' +\r\n                                    '<div class=\"file form-control form-control-sm\"><label for=\"file'+ident+'\" class=\"choose_file_button action_button p-0 w-100\" tabindex=\"0\">'+strings.choose_file+'</label><input id=\"file'+ident+'\" type=\"file\" class=\"d-none\"></div>' +\r\n                                '</div>'\r\n                            );\r\n                \r\n                noteAttachment.hide();\r\n            }\r\n            \r\n            notecontent.append(noteHeading);\r\n            notecontent.append(noteText);\r\n            notecontent.append(noteAriaText);\r\n            if (iseditable) {\r\n                notecontent.append(noteAttachment);\r\n            }\r\n            \r\n            notecontent.append(attachmentPreview);\r\n            note.append(notecontent);\r\n                        \r\n            if (iseditable) {\r\n                var attachmentType = noteAttachment.find('.type');\r\n                var attachmentInfo = noteAttachment.find('.info');\r\n                var attachmentUrl = noteAttachment.find('.url');\r\n                var attachmentFileInput = noteAttachment.find('.file>input');\r\n                var attachmentIcon = noteAttachment.find('.type_icon');\r\n                \r\n                attachmentType.on('change', function() {\r\n                    attachmentTypeChanged(note);\r\n                    previewAttachment(note);\r\n                });\r\n                \r\n                attachmentUrl.on('change', function() {\r\n                    previewAttachment(note);\r\n                });\r\n                \r\n                attachmentFileInput.on('change', function() {\r\n                    preloadFile(note, function() {\r\n                        previewAttachment(note);\r\n                    });\r\n                });\r\n                \r\n                attachmentInfo.on('change', function() {\r\n                    previewAttachment(note);\r\n                });\r\n                \r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    var removeAttachment = $('<div class=\"remove remove_attachment fa fa-remove\"></div>');\r\n                    removeAttachment.hide();\r\n                    removeAttachment.on('click', function() { attachmentType.val(0); attachmentType.trigger('change'); });\r\n                    noteAttachment.append(removeAttachment);\r\n                }\r\n            }\r\n            \r\n            var column_content = $('.board_column[data-ident='+columnid+'] .board_column_content');\r\n            \r\n            if (iseditable) {\r\n                var buttons = $('<div class=\"note_buttons\"></div>');\r\n                buttons.hide();\r\n                var postbutton = $('<div class=\"post_button action_button\" role=\"button\" tabindex=\"0\">'+strings.post_button_text+'</div>');\r\n                var cancelbutton = $('<div class=\"cancel_button action_button\" role=\"button\" tabindex=\"0\">'+strings.cancel_button_text+'</div>');\r\n                \r\n                buttons.append(postbutton);\r\n                buttons.append(cancelbutton);\r\n                \r\n                if (mediaSelection==MEDIA_SELECTION_BUTTONS) {\r\n                    buttons.append('<div class=\"spacer_button\"></div>');\r\n                    var ytButton = $('<div class=\"attachment_button youtube_button action_button fa '+attachmentFAIcons[0]+'\" role=\"button\" tabindex=\"0\"></div>');\r\n                    handleAction(ytButton, function() { attachmentType.val(1); attachmentType.trigger(\"change\"); });\r\n                    var imgButton = $('<div class=\"attachment_button image_button action_button fa '+attachmentFAIcons[1]+'\" role=\"button\" tabindex=\"0\"></div>');\r\n                    handleAction(imgButton, function() { attachmentType.val(2); attachmentType.trigger(\"change\"); });\r\n                    var linkButton = $('<div class=\"attachment_button link_button action_button fa '+attachmentFAIcons[2]+'\" role=\"button\" tabindex=\"0\"></div>');\r\n                    handleAction(linkButton, function() { attachmentType.val(3); attachmentType.trigger(\"change\"); });\r\n                    buttons.append(ytButton);\r\n                    buttons.append(imgButton);\r\n                    buttons.append(linkButton);\r\n                }\r\n                \r\n                note.append(buttons);\r\n                \r\n                var removeElement = $('<div class=\"remove fa fa-remove delete_note\" role=\"button\" tabindex=\"0\"></div>');\r\n                handleAction(removeElement, function() {\r\n                    deleteNote(ident);\r\n                });\r\n                \r\n                if (!ident) {\r\n                    removeElement.hide();\r\n                }\r\n                notecontent.append(removeElement);\r\n                \r\n                handleAction(cancelbutton, function() {\r\n                    stopNoteEdit();\r\n                });\r\n                \r\n                noteText.on('click', function(e) {\r\n                    if ((editingNote && editingNote==ident) || !ident) {\r\n                        noteText.editable('open');\r\n                    }\r\n                });\r\n                \r\n                var beginEdit = function() {\r\n                    startNoteEdit(ident);\r\n                };\r\n\r\n                noteHeading.on('click', function(e) {\r\n                    if ((editingNote && editingNote==ident) || !ident) {\r\n                        noteHeading.editable('open');\r\n                    }\r\n                });\r\n                \r\n                attachmentPreview.on('dblclick', beginEdit);\r\n                \r\n                handleAction(postbutton, function() {\r\n                    var sendAttach = attachmentDataForNote(note);\r\n                    \r\n                    noteHeading.editable('close');\r\n                    var theHeading = noteHeading.html();\r\n                    noteText.editable('close');\r\n                    var theText = noteText.html().substring(0, options.post_max_length);\r\n                    \r\n                    if (!theHeading && !theText && !sendAttach.url && !sendAttach.filename) {\r\n                        return;\r\n                    }\r\n                    \r\n                    if (postbutton.data('disabled')) {\r\n                        return;\r\n                    }\r\n                    \r\n                    postbutton.data('disabled', true);\r\n                    \r\n                    if (!ident) { // new\r\n                        serviceCall('add_note', {columnid: columnid, heading: theHeading, content: theText, attachment: sendAttach}, function(result) {\r\n                            if (result.status) {\r\n                                lastHistoryId = result.historyid;\r\n                                note.remove();\r\n                                showNewNoteButtons();\r\n                                addNote(columnid, result.note.id, result.note.heading, result.note.content, {type: result.note.type, info: result.note.info, url: result.note.url}, {id: result.note.userid}, result.note.timecreated, result.note.rating);\r\n                                sortNotes(column_content);\r\n                                updateNoteAria(result.note.id);\r\n                                \r\n                            } else {\r\n                                postbutton.data('disabled', false);\r\n                            }\r\n                        });\r\n                        \r\n                    } else { // update\r\n                        serviceCall('update_note', {id: ident, heading: theHeading, content: theText, attachment: sendAttach}, function(result) {\r\n                            if (result.status) {\r\n                                lastHistoryId = result.historyid;\r\n                                successNoteEdit();\r\n                                noteText.html(result.note.content);\r\n                                updateNoteAria(ident);\r\n                                setAttachment(note, {type: result.note.type, info: result.note.info, url: result.note.url});\r\n                            }\r\n                            postbutton.data('disabled', false);\r\n                        });\r\n                    }\r\n                });\r\n                \r\n                handleEditableAction(noteText, beginEdit);\r\n                noteText.editable({\r\n                    toggleFontSize : false,\r\n                    closeOnEnter: false,\r\n                    callback : function( data ) {\r\n                        noteText.html(noteText.html().substring(0, options.post_max_length));\r\n                    }\r\n                });\r\n                \r\n                handleEditableAction(noteHeading, beginEdit);\r\n                noteHeading.editable({\r\n                    toggleFontSize : false,\r\n                    closeOnEnter: true\r\n                });\r\n                \r\n                setAttachment(note, attachment);\r\n            } else {\r\n                previewAttachment(note, attachment);\r\n            }\r\n            \r\n            if (ident) {\r\n                if (ratingenabled) {\r\n                    note.addClass('rateablenote');\r\n                    var rateElement = $('<div class=\"fa fa-star rating\" role=\"button\" tabindex=\"0\">'+rating+'</div>');\r\n                \r\n                    handleAction(rateElement, function() {\r\n                        rateNote(ident);\r\n                    });\r\n                    notecontent.append(rateElement);\r\n                }\r\n                \r\n                if (!noteHeading.html()) {\r\n                    noteHeading.hide();\r\n                }\r\n                var lastOne = column_content.find(\".board_note\").last();\r\n                if (lastOne.length) {\r\n                    note.insertAfter(lastOne);\r\n                } else {\r\n                    column_content.prepend(note);\r\n                }\r\n            } else {\r\n                $('.board_column[data-ident='+columnid+'] .board_column_newcontent').append(note);\r\n                updateNoteAria(ident);\r\n                noteText.editable('open'); // trigger edit of note\r\n                beginEdit();\r\n            }\r\n        };\r\n        \r\n        var addColumn = function(ident, name, notes, sort) {\r\n            var iseditable = isEditor;\r\n            var nameCache = null;\r\n            var column = $('<div class=\"board_column board_column_hasdata\" data-ident=\"'+ident+'\"></div>');\r\n            var column_header = $('<div class=\"board_column_header\"></div>');\r\n            var column_sort = $('<div class=\"column_sort fa\"></div>');\r\n            var column_name = $('<div class=\"column_name\" tabindex=\"0\" aria-level=\"3\" role=\"heading\">'+name+'</div>');\r\n            var column_content = $('<div class=\"board_column_content\"></div>');\r\n            var column_newcontent = $('<div class=\"board_column_newcontent\"></div>');\r\n            column_header.append(column_sort);\r\n            column_header.append(column_name);\r\n            \r\n            if (options.hideheaders) {\r\n                column_name.addClass('d-none');\r\n            }\r\n            \r\n            column_sort.on('click', function() {\r\n                sortNotes(column_content, true);\r\n            });\r\n            \r\n            if (iseditable) {\r\n                column.addClass('editablecolumn');\r\n\r\n                var removeElement = $('<div class=\"remove fa fa-remove delete_column\" role=\"button\" tabindex=\"0\"></div>');\r\n                handleAction(removeElement, function() {\r\n                    if (confirm(strings.remove_column_text)) {\r\n                        serviceCall('delete_column', {id: ident}, function(result) {\r\n                            if (result.status) {\r\n                                column.remove();\r\n                                lastHistoryId = result.historyid;\r\n                            }\r\n                        });\r\n                    }\r\n                });\r\n                \r\n                column_header.append(removeElement);\r\n            }\r\n            \r\n            column.append(column_header);\r\n            column.append(column_content);\r\n            column.append(column_newcontent);\r\n            \r\n            if (iseditable) {\r\n                handleEditableAction(column_name, function() {\r\n                    nameCache = column_name.html();\r\n                }, true);\r\n                \r\n                column_name.editable({\r\n                    toggleFontSize : false,\r\n                    closeOnEnter: true,\r\n                    callback : function( data ) {\r\n                        if ( data.content ) {\r\n                            serviceCall('update_column', {id: ident, name: column_name.html()}, function(result) {\r\n                                if (!result.status) {\r\n                                    column_name.html(nameCache);\r\n                                    nameCache = null;\r\n                                } else {\r\n                                    lastHistoryId = result.historyid;\r\n                                    updateColumnAria(ident);\r\n                                }\r\n                            }, function() {\r\n                                column_name.html(nameCache);\r\n                                nameCache = null;\r\n                            });\r\n                        } else {\r\n                            column_name.html(nameCache);\r\n                            nameCache = null;\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n\r\n            if (!isReadOnlyBoard) {\r\n                column_newcontent.append('<div class=\"board_button newnote\" role=\"button\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa '+options.noteicon+'\"></span></div></div>');\r\n                \r\n                handleAction(column_newcontent.find('.newnote'), function() {\r\n                    addNote(ident, 0, null, null, null, {id: userId}, 0, 0);\r\n                });\r\n            }\r\n\r\n            var lastOne = $(\".mod_board .board_column_hasdata\").last();\r\n            if (lastOne.length) {\r\n                column.insertAfter(lastOne);\r\n            } else {\r\n                $(\".mod_board\").append(column);\r\n            }\r\n                        \r\n            if (notes) {\r\n                for (index in notes) {\r\n                    addNote(ident, notes[index].id, notes[index].heading, notes[index].content, {type: notes[index].type, info: notes[index].info, url: notes[index].url}, {id: notes[index].userid}, notes[index].timecreated, notes[index].rating);\r\n                }\r\n            }\r\n            sortNotes(column_content);\r\n            updateColumnAria(ident);\r\n            isEditor && updateSortable();\r\n        };\r\n        \r\n        var addNewColumnButton = function() {\r\n            var column = $('<div class=\"board_column board_column_empty\"></div>');\r\n            var newBusy = false;\r\n            column.append('<div class=\"board_button newcolumn\" role=\"button\" tabindex=\"0\" aria-label=\"'+strings.aria_newcolumn+'\"><div class=\"button_content\"><span class=\"fa '+options.columnicon+'\"></span></div></div>');\r\n            \r\n            handleAction(column.find('.newcolumn'), function() {\r\n                if (newBusy) {\r\n                    return;\r\n                }\r\n                newBusy = true;\r\n                \r\n                serviceCall('add_column', {boardid: board.id, name: strings.default_column_heading}, function(result) {\r\n                    addColumn(result.id, strings.default_column_heading);\r\n                    lastHistoryId = result.historyid;\r\n                    newBusy = false;\r\n                }, function(error) {\r\n                    newBusy = false;\r\n                });\r\n            });\r\n            \r\n            $(\".mod_board\").append(column);\r\n        };\r\n        \r\n        var processBoardHistory = function() {\r\n            serviceCall('board_history', {id: board.id, since: lastHistoryId}, function(boardhistory) {\r\n                for (index in boardhistory) {\r\n                    var item = boardhistory[index];\r\n                    if (item.boardid!=board.id) {\r\n                        continue; // hmm\r\n                    }\r\n                    \r\n                    var data = JSON.parse(item.content);\r\n                    if (item.action=='add_note') {\r\n                        addNote(data.columnid, data.id, data.heading, data.content, data.attachment, {id: item.userid}, data.timecreated, data.rating);\r\n                        updateNoteAria(data.id);\r\n                        sortNotes($('.board_column[data-ident='+data.columnid+'] .board_column_content'));\r\n                    } else if (item.action=='update_note') {\r\n                        var note = getNote(data.id);\r\n                        if (note) {\r\n                            var heading = getNoteHeadingForNote(note);\r\n                            \r\n                            var updateNote = function() {\r\n                                heading.html(data.heading);\r\n                                if (data.heading) {\r\n                                    heading.show();\r\n                                } else {\r\n                                    heading.hide();\r\n                                }\r\n                                getNoteTextForNote(note).html(data.content);\r\n                                setAttachment(note, data.attachment);\r\n                                noteTextCache = null;\r\n                                noteHeadingCache = null;\r\n                                attachmentCache = null;\r\n                                updateNoteAria(data.id);\r\n                            };\r\n                            \r\n                            if (editingNote==data.id) {\r\n                                Notification.confirm(\r\n                                    strings.note_changed_text.split(\"\\n\")[0], // Confirm.\r\n                                    strings.note_changed_text.split(\"\\n\")[1], // Are you sure?\r\n                                    strings.Ok,\r\n                                    strings.Cancel,\r\n                                    function() {\r\n                                        if (editingNote==data.id) {\r\n                                            updateNote();\r\n                                        }\r\n                                        stopNoteEdit();\r\n                                    }\r\n                                );\r\n                            } else {\r\n                                updateNote();\r\n                            }\r\n                        }\r\n                    } else if (item.action=='delete_note') {\r\n                        if (editingNote==data.id) {\r\n                            Notification.alert(strings.warning, strings.note_deleted_text);\r\n                            stopNoteEdit();\r\n                        }\r\n                        getNote(data.id).remove();\r\n                        \r\n                    } else if (item.action=='add_column') {\r\n                        addColumn(data.id, data.name);\r\n                    } else if (item.action=='update_column') {\r\n                        $(\".board_column[data-ident='\"+data.id+\"'] .column_name\").html(data.name);\r\n                        updateColumnAria(data.id);\r\n                    } else if (item.action=='delete_column') {\r\n                        var column = $(\".board_column[data-ident='\"+data.id+\"']\");\r\n                        if (editingNote && column.find('.board_note[data-ident=\"'+editingNote+'\"]').length) {\r\n                            stopNoteEdit();\r\n                        }\r\n                        column.remove();\r\n                    } else if (item.action=='rate_note') {\r\n                        var note = getNote(data.id)\r\n                        note.find('.rating').html(data.rating);\r\n                        if (sortby==SORTBY_RATING) {\r\n                            sortNotes(note.closest('.board_column_content'));\r\n                        }\r\n                    }\r\n                    lastHistoryId = item.id;\r\n                }\r\n                \r\n                updateBoard();\r\n            });\r\n        };\r\n        \r\n        var updateBoard = function(instant) {\r\n            if (instant) {\r\n                processBoardHistory();\r\n            } else if (options.history_refresh > 0) {\r\n                if (reloadTimer) {\r\n                    stopUpdating();\r\n                }\r\n                reloadTimer = setTimeout(processBoardHistory, options.history_refresh * 1000);\r\n            }\r\n        };\r\n        \r\n        var stopUpdating = function() {\r\n            clearTimeout(reloadTimer);\r\n            reloadTimer = null;\r\n        };\r\n        \r\n        var sortNotes = function(content, toggle) {\r\n            var sort_col = $(content).parent().find('.column_sort');\r\n            var direction = $(content).data('sort');\r\n            if (!direction) {\r\n                if (sortby==SORTBY_RATING) {\r\n                    direction = 'desc';\r\n                } else {\r\n                    direction = 'asc';\r\n                }\r\n            }\r\n            if (toggle) {\r\n                direction = direction=='asc'?'desc':'asc';\r\n            }\r\n            \r\n            if (direction=='asc') {\r\n                sort_col.removeClass('fa-angle-down');\r\n                sort_col.addClass('fa-angle-up');\r\n            } else {\r\n                sort_col.removeClass('fa-angle-up');\r\n                sort_col.addClass('fa-angle-down');\r\n            }\r\n            $(content).data('sort', direction);\r\n\r\n            if (sortby==SORTBY_DATE) {\r\n                var desc = function(a, b) {\r\n                    return $(b).data(\"sortorder\") - $(a).data(\"sortorder\");\r\n                };\r\n                var asc = function(a, b) {\r\n                    return $(a).data(\"sortorder\") - $(b).data(\"sortorder\");\r\n                };\r\n            } else if (sortby==SORTBY_RATING) {\r\n                var desc = function(a, b) {\r\n                    return $(b).find('.rating').text() - $(a).find('.rating').text() || $(b).data(\"sortorder\") - $(a).data(\"sortorder\");\r\n                };\r\n                var asc = function(a, b) {\r\n                    return $(a).find('.rating').text() - $(b).find('.rating').text() || $(a).data(\"sortorder\") - $(b).data(\"sortorder\");\r\n                };\r\n            }\r\n            \r\n            $('> .board_note', $(content)).sort(direction=='asc'?asc:desc).appendTo($(content));\r\n            \r\n        };\r\n        \r\n        var updateSortable = function() {\r\n            $( \".board_column_content\" ).sortable({\r\n                connectWith: \".board_column_content\",\r\n                stop: function(e, ui) {\r\n                    var note = $(ui.item);\r\n                    var tocolumn = note.closest('.board_column');\r\n                    var columnid = tocolumn.data('ident')\r\n                    \r\n                    var elem = $(this);\r\n                    serviceCall('move_note', {id: note.data('ident'), columnid: columnid}, function(result) {\r\n                        if (result.status) {\r\n                            lastHistoryId = result.historyid;\r\n                            updateNoteAria(note.data('ident'));\r\n                            sortNotes($('.board_column[data-ident='+columnid+'] .board_column_content'));\r\n                        } else {\r\n                            elem.sortable('cancel');\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n        var init = function() {\r\n            serviceCall('get_board', {id: board.id}, function(columns) {\r\n                // init\r\n                if (columns) {\r\n                    for (index in columns) {\r\n                        addColumn(columns[index].id, columns[index].name, columns[index].notes || {});\r\n                    }\r\n                }\r\n                \r\n                isEditor && addNewColumnButton();\r\n                \r\n                lastHistoryId = board.historyid;\r\n                \r\n                isEditor && updateSortable();\r\n                \r\n                updateBoard();\r\n            });\r\n        };\r\n   \r\n        // get strings\r\n        var stringsInfo = [];\r\n        for (string in strings) {\r\n            stringsInfo.push({key: string, component: 'mod_board'});\r\n        }\r\n                \r\n        $.when(Str.get_strings(stringsInfo)).done(function(results) {\r\n            var index = 0;\r\n            for (string in strings) {\r\n                strings[string] = results[index++];\r\n            }\r\n            \r\n            init();\r\n        });\r\n    };\r\n});"],"file":"board.min.js"}
