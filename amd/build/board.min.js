define ("mod_board/board",["jquery","core/str","core/ajax","core/notification","core/templates","mod_board/jquery.editable.amd"],function(c,a,b,d){var e=function(a,c,e,f){b.call([{methodname:"mod_board_"+a,args:c,done:function(a){e(a)}.bind(this),fail:function fail(a){d.exception(a);if(f){f(a)}}}])};return function(b,f){var g={default_column_heading:"",post_button_text:"",cancel_button_text:"",remove_note_text:"",remove_column_text:"",note_changed_text:"",note_deleted_text:"",Ok:"",Cancel:"",warning:"",option_youtube:"",option_youtube_info:"",option_youtube_url:"",option_image:"",option_image_info:"",option_image_url:"",option_link:"",option_link_info:"",option_link_url:"",option_empty:""},h=1,i=null,j=null,k=f.isEditor||!1,l=f.userId||-1,m=f.mediaselection||h,n=null,o=null,p=null,q=0,r=f.readonly||!1,s=function(a,b,c,d){if("board_history"!==a){S()}e(a,b,function(){c.apply(null,arguments);if("board_history"!==a){R(!0)}},d)},t=function(a){return c(".board_note[data-ident='"+a+"']")},u=function(a){return c(".board_note[data-ident='"+a+"'] .note_text")},v=function(a){return c(a).find(".note_text")},w=function(a){return c(".board_note[data-ident='"+a+"'] .note_heading")},x=function(a){return c(a).find(".note_heading")},y=function(a){return c(a).find(".note_buttons")},z=function(){c(".board_column .board_column_newcontent .board_button.newnote").show()},A=function(){c(".board_column .board_column_newcontent .board_button.newnote").hide()},B=function(a){return c(a).find(".note_attachment")},C=function(){n=null;o=null;p=null;D()},D=function(){if(!q){t(0).remove();z();return}if(n){u(q).html(n);n=null}if(o){w(q).html(o);o=null}var a=t(q);if(a){if(p){H(a,p);p=null}else{M(a)}y(a).hide();B(a).hide();z();var b=x(a);if(!b.html()){b.hide()}}q=0},E=function(a){if(q){if(q==a){return}D()}if(a){var b=t(0);if(b){b.remove()}}var c=t(a);if(c){y(c).show();B(c).show();A();var d=x(c);if(a){p=I(c);n=v(c).html();o=d.html();q=a}d.show()}},F=function(a){if(confirm(g.remove_note_text)){s("delete_note",{id:a},function(b){if(b.status){j=b.historyid;t(a).remove()}})}},G=function(a){var b=B(a),c=b.find(".type").val(),d=b.find(".info"),e=b.find(".url");if(m==h){var f=b.find(".type_icon"),i=b.find(".remove_attachment")}else{y(a).find(".attachment_button").hide()}if("0"<c){if(m==h){i.show()}d.prop("placeholder",g["option_"+J(c)+"_info"]);e.prop("placeholder",g["option_"+J(c)+"_url"]);d.show();e.show();if(m==h){f.removeClass().addClass(["type_icon","fa",L(c)]);f.show();y(a).find(".attachment_button").hide()}}else{if(m==h){i.hide()}d.hide();e.hide();if(m==h){f.hide()}d.val("");e.val("");if(m==h){y(a).find(".attachment_button").show()}}},H=function(a,b){var c=B(a);if(c){if(!b){b={type:"0"}}else{b.type+=""}var d=c.find(".type");d.val(b.type?b.type:"0");if("0"<d.val()){c.find(".info").val(b.info);c.find(".url").val(b.url)}G(a,b)}M(a,b)},I=function(a){var b={type:0,info:null,url:null},c=B(a);if(c){b.type=c.find(".type").val();b.info=c.find(".info").val();b.url=c.find(".url").val()}if(!b.info.length&&!b.url.length){b.type=0}return b},J=function(a){switch(a){case"1":return"youtube";case"2":return"image";case"3":return"link";default:return null;}},K=["fa-youtube","fa-picture-o","fa-link"],L=function(a){return K[a-1]||null},M=function(a,b){var c=a.find(".preview");if(!b){b=I(a)}var d=function(a){return a.replace(/watch\?v=/gi,"/embed/").replace(/youtu\.be/,"youtube.com/embed")};if(!v(a).html().length){c.addClass("notext")}else{c.removeClass("notext")}c.removeClass("wrapper_youtube");c.removeClass("wrapper_image");c.removeClass("wrapper_url");if(b.url){switch(parseInt(b.type)){case 1:c.html("<iframe src=\""+d(b.url)+"\" class=\"preview_element\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>");c.addClass("wrapper_youtube");c.show();break;case 2:c.html("<a href=\""+b.url+"\" target=\"_blank\"><img src=\""+b.url+"\" class=\"preview_element\" alt=\""+b.info+"\"/></a>");c.addClass("wrapper_image");c.show();break;case 3:c.html("<a href=\""+b.url+"\" class=\"preview_element\" target=\"_blank\">"+(b.info||b.url)+"</a>");c.addClass("wrapper_url");c.show();break;default:c.html("");c.hide();}}else{c.html("");c.hide()}},N=function(a,b,d,e,f,i){var n=i.id==l||!b,o=k||n&&!r;if(!b){var p=t(0);if(p){p.remove()}}var u=c("<div class=\"board_note\" data-ident=\""+b+"\"></div>");if(n){u.addClass("mynote")}if(o){u.addClass("editablenote")}var v=c("<div class=\"note_content\"></div>"),w=c("<div class=\"note_heading\" tabindex=\"0\">"+(d?d:"")+"</div>"),x=c("<div class=\"note_text\" tabindex=\"0\">"+(e?e:"")+"</div>"),y=c("<div class=\"preview\"></div>");if(o){var A=c("<div class=\"note_attachment form-group row\" tabindex=\"0\"><select class=\"type form-control form-control-sm "+(m==h?"hidden":"")+"\"><option value=\"0\">"+g.option_empty+"</option><option value=\"1\">"+g.option_youtube+"</option><option value=\"2\">"+g.option_image+"</option><option value=\"3\">"+g.option_link+"</option></select><span class=\"type_icon fa "+(m==2?"hidden":"")+"\"></span><input type=\"text\" class=\"info form-control form-control-sm col-sm-12 "+(m==h?"with_type_icon":"")+"\" placeholder=\"\"><input type=\"text\" class=\"url form-control form-control-sm col-sm-12\" placeholder=\"\"></div>");A.hide()}v.append(w);v.append(x);if(o){v.append(A)}v.append(y);u.append(v);if(o){var B=A.find(".type"),J=A.find(".info"),L=A.find(".url"),O=A.find(".type_icon");B.on("change",function(){G(u);M(u)});L.on("change",function(){M(u)});J.on("change",function(){M(u)});if(m==h){var P=c("<div class=\"remove remove_attachment fa fa-remove\"></div>");P.hide();P.on("click",function(){B.val(0);B.trigger("change")});A.append(P)}}var Q=c(".board_column[data-ident="+a+"] .board_column_content");if(o){var R=c("<div class=\"note_buttons\"></div>");R.hide();var S=c("<div class=\"post_button action_button\" role=\"button\" tabindex=\"0\">"+g.post_button_text+"</div>"),U=c("<div class=\"cancel_button action_button\" role=\"button\" tabindex=\"0\">"+g.cancel_button_text+"</div>");R.append(S);R.append(U);if(m==h){R.append("<div class=\"spacer_button\"></div>");var V=c("<div class=\"attachment_button youtube_button action_button fa "+K[0]+"\" role=\"button\" tabindex=\"0\"></div>");V.on("click",function(){B.val(1);B.trigger("change")});var W=c("<div class=\"attachment_button image_button action_button fa "+K[1]+"\" role=\"button\" tabindex=\"0\"></div>");W.on("click",function(){B.val(2);B.trigger("change")});var X=c("<div class=\"attachment_button link_button action_button fa "+K[2]+"\" role=\"button\" tabindex=\"0\"></div>");X.on("click",function(){B.val(3);B.trigger("change")});R.append(V);R.append(W);R.append(X)}u.append(R);var Y=c("<div class=\"remove fa fa-remove\" role=\"button\" tabindex=\"0\"></div>");Y.on("click keypress",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault()}else{return}}F(b)});if(!b){Y.hide()}v.append(Y);U.on("click keypress",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault()}else{return}}D()});x.on("click",function(){if(q&&q==b||!b){x.editable("open")}});var Z=function(){E(b)};x.on("dblclick keypress",function(a){if("keypress"==a.type){if(13===a.keyCode&&!x.is(":editing")){a.preventDefault();x.dblclick();return}else{return}}Z()});w.on("click",function(){if(q&&q==b||!b){w.editable("open")}});w.on("dblclick keypress",function(a){if("keypress"==a.type){if(13===a.keyCode&&!w.is(":editing")){a.preventDefault();w.dblclick();return}else{return}}Z()});y.on("dblclick",function(){Z()});S.on("click keypress",function(c){if("keypress"==c.type){if(13===c.keyCode){c.preventDefault()}else{return}}var d=I(u);if(!b){var e=w.html(),f=x.html();s("add_note",{columnid:a,heading:e,content:f,attachment:d},function(b){j=b.historyid;u.remove();z();N(a,b.id,e,f,d,{id:l});T(Q)})}else{s("update_note",{id:b,heading:w.html(),content:x.html(),attachment:d},function(a){if(a.status){H(u,d);C();j=a.historyid}})}});x.editable({toggleFontSize:!1,closeOnEnter:!1});w.editable({toggleFontSize:!1,closeOnEnter:!0});H(u,f)}else{M(u,f)}if(b){if(!w.html()){w.hide()}var $=Q.find(".board_note").last();if($.length){u.insertAfter($)}else{Q.prepend(u)}}else{c(".board_column[data-ident="+a+"] .board_column_newcontent").append(u);x.dblclick()}},O=function(a,b,d){var e=k,h=null,i=c("<div class=\"board_column board_column_hasdata\" data-ident=\""+a+"\"></div>"),m=c("<div class=\"board_column_header\"></div>"),n=c("<div class=\"column_sort fa\"></div>"),o=c("<div class=\"column_name\" tabindex=\"0\">"+b+"</div>"),p=c("<div class=\"board_column_content\"></div>"),q=c("<div class=\"board_column_newcontent\"></div>");m.append(n);m.append(o);n.on("click",function(){T(p,!0)});if(e){i.addClass("editablecolumn");var t=c("<div class=\"remove fa fa-remove\" role=\"button\" tabindex=\"0\"></div>");t.on("click keypress",function(b){if("keypress"==b.type){if(13===b.keyCode){b.preventDefault()}else{return}}if(confirm(g.remove_column_text)){s("delete_column",{id:a},function(a){if(a.status){i.remove();j=a.historyid}})}});m.append(t)}i.append(m);i.append(p);i.append(q);if(e){o.on("dblclick keypress",function(a){if("keypress"==a.type){if(13===a.keyCode&&!o.is(":editing")){a.preventDefault();o.dblclick()}else{return}}h=o.html()});o.editable({toggleFontSize:!1,closeOnEnter:!0,callback:function callback(b){if(b.content){s("update_column",{id:a,name:o.html()},function(a){if(!a.status){o.html(h);h=null}else{j=a.historyid}},function(){o.html(h);h=null})}}})}if(!r){q.append("<div class=\"board_button newnote\" role=\"button\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa "+f.noteicon+"\"></span></div></div>");q.on("click keypress",".newnote",function(b){if("keypress"==b.type){if(13===b.keyCode){b.preventDefault()}else{return}}N(a,0,null,null,null,{id:l})})}var u=c(".mod_board .board_column_hasdata").last();if(u.length){i.insertAfter(u)}else{c(".mod_board").append(i)}if(d){for(index in d){N(a,d[index].id,d[index].heading,d[index].content,{type:d[index].type,info:d[index].info,url:d[index].url},{id:d[index].userid})}}T(p,!0)},P=function(){var a=c("<div class=\"board_column board_column_empty\"></div>"),d=!1;a.append("<div class=\"board_button newcolumn\" role=\"button\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa "+f.columnicon+"\"></span></div></div>");a.on("click keypress",".newcolumn",function(a){if(d){return}d=!0;if("keypress"==a.type){if(13===a.keyCode){a.preventDefault()}else{return}}s("add_column",{boardid:b.id,name:g.default_column_heading},function(a){O(a.id,g.default_column_heading);j=a.historyid;d=!1},function(){d=!1})});c(".mod_board").append(a)},Q=function(){s("board_history",{id:b.id,since:j},function(a){for(index in a){var e=a[index];if(e.boardid!=b.id){continue}var f=JSON.parse(e.content);if("add_note"==e.action){N(f.columnid,f.id,f.heading,f.content,f.attachment,{id:e.userid})}else if("update_note"==e.action){var h=t(f.id);if(h){var i=x(h),k=function(){i.html(f.heading);if(f.heading){i.show()}else{i.hide()}v(h).html(f.content);H(h,f.attachment);n=null;o=null;p=null};if(q==f.id){d.confirm(g.note_changed_text.split("\n")[0],g.note_changed_text.split("\n")[1],g.Ok,g.Cancel,function(){if(q==f.id){k()}D()})}else{k()}}}else if("delete_note"==e.action){if(q==f.id){d.alert(g.warning,g.note_deleted_text);D()}t(f.id).remove()}else if("add_column"==e.action){O(f.id,f.name)}else if("update_column"==e.action){c(".board_column[data-ident='"+f.id+"'] .column_name").html(f.name)}else if("delete_column"==e.action){var l=c(".board_column[data-ident='"+f.id+"']");if(q&&l.find(".board_note[data-ident=\""+q+"\"]").length){D()}l.remove()}j=e.id}R()})},R=function(a){if(a){Q()}else{if(i){S()}i=setTimeout(Q,2e3)}},S=function(){clearTimeout(i);i=null},T=function(a,b){var d=c(a).parent().find(".column_sort"),e=c(a).data("sort");if(b){e="asc"==e?"desc":"asc"}if("asc"==e){d.removeClass("fa-angle-down");d.addClass("fa-angle-up")}else{d.removeClass("fa-angle-up");d.addClass("fa-angle-down")}c(a).data("sort",e);c("> .board_note",c(a)).sort("asc"==e?function(d,a){return c(a).data("ident")<c(d).data("ident")?1:-1}:function(d,a){return c(a).data("ident")<c(d).data("ident")?-1:1}).appendTo(c(a))},U=function(){s("get_board",{id:b.id},function(a){if(a){for(index in a){O(a[index].id,a[index].name,a[index].notes||{})}}if(k){P()}j=b.historyid})},V=[];for(string in g){V.push({key:string,component:"mod_board"})}c.when(a.get_strings(V)).done(function(a){var b=0;for(string in g){g[string]=a[b++]}U()})}});
//# sourceMappingURL=board.min.js.map
