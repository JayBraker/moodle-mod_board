define ("mod_board/board",["jquery","core/str","core/ajax","core/notification","core/templates","mod_board/jquery.editable.amd"],function(c,a,b,d){var e=function(a,c,e,f){b.call([{methodname:"mod_board_"+a,args:c,done:function(a){e(a)}.bind(this),fail:function fail(a){d.exception(a);if(f){f(a)}}}])},f=function(a){return 13==a||32==a},g=function(a,b){return a.on("click keypress",function(a){if("keypress"==a.type){if(f(a.keyCode)){a.preventDefault()}else{return}}b()})},h=function(a,b,c){if(a.is(":editable")){throw new Error("handleEditableAction - must be called before setting the element as editable")}return a.on("dblclick keypress",function(d){if("keypress"==d.type){if(f(d.keyCode)&&!a.is(":editing")){d.preventDefault();if(c){b()}a.editable("open");if(c){return}}else{return}}b()})};return function(b,f){var i={default_column_heading:"",post_button_text:"",cancel_button_text:"",remove_note_text:"",remove_column_text:"",note_changed_text:"",note_deleted_text:"",Ok:"",Cancel:"",warning:"",option_youtube:"",option_youtube_info:"",option_youtube_url:"",option_image:"",option_image_info:"",option_image_url:"",option_link:"",option_link_info:"",option_link_url:"",option_empty:"",aria_newcolumn:"",aria_newpost:"",aria_deletecolumn:"",aria_deletepost:"",aria_addmedia:"",aria_addmedianew:"",aria_deleteattachment:"",aria_postedit:"",aria_canceledit:"",aria_postnew:"",aria_cancelnew:""},j=1,k=null,l=null,m=f.isEditor||!1,n=f.userId||-1,o=f.mediaselection||j,p=null,q=null,r=null,s=0,t=f.readonly||!1,u=function(a,b,c,d){if("board_history"!==a){X()}e(a,b,function(){c.apply(null,arguments);if("board_history"!==a){W(!0)}},d)},v=function(a){return c(".board_note[data-ident='"+a+"']")},w=function(a){return c(".board_note[data-ident='"+a+"'] .note_text")},x=function(a){return c(a).find(".note_text")},y=function(a){return c(".board_note[data-ident='"+a+"'] .note_heading")},z=function(a){return c(a).find(".note_heading")},A=function(a){return c(a).find(".note_buttons")},B=function(){c(".board_column .board_column_newcontent .board_button.newnote").show()},C=function(){c(".board_column .board_column_newcontent .board_button.newnote").hide()},D=function(a){return c(a).find(".note_attachment")},E=function(a){var b=x(a).html(),c=z(a).html(),d=N(a);if(0<c.length){return c}if(0<b.length){return b.replace(/<br\s*\/?>/gi," ").replace(/\n/g," ").split(/\s+/).slice(0,5).join(" ")}if(d.info&&0<d.info.length){return d.info}return null},F=function(a){var b=v(a),c=b.closest(".board_column").find(".column_name").text(),d=cancel_button=add_youtube=add_image=add_link=remove_attachment="";if(!a){d=i.aria_postnew.replace("{column}",c);cancel_button=i.aria_cancelnew.replace("{column}",c);add_youtube=i.aria_addmedianew.replace("{type}",i.option_youtube).replace("{column}",c);add_image=i.aria_addmedianew.replace("{type}",i.option_image).replace("{column}",c);add_link=i.aria_addmedianew.replace("{type}",i.option_link).replace("{column}",c)}else{var e=E(b);d=i.aria_postedit.replace("{column}",c).replace("{post}",e);cancel_button=i.aria_canceledit.replace("{column}",c).replace("{post}",e);add_youtube=i.aria_addmedia.replace("{type}",i.option_youtube).replace("{column}",c).replace("{post}",e);add_image=i.aria_addmedia.replace("{type}",i.option_image).replace("{column}",c).replace("{post}",e);add_link=i.aria_addmedia.replace("{type}",i.option_link).replace("{column}",c).replace("{post}",e);remove_attachment=i.aria_deleteattachment.replace("{column}",c).replace("{post}",e);b.find(".delete_note").attr("aria-label",i.aria_deletepost.replace("{column}",c).replace("{post}",e));b.find(".note_ariatext").html(e)}if(o==j){if(a){var f=b.find(".remove_attachment");if(f){f.attr("aria-label",remove_attachment)}}b.find(".attachment_button.youtube_button").attr("aria-label",add_youtube);b.find(".attachment_button.image_button").attr("aria-label",add_image);b.find(".attachment_button.link_button").attr("aria-label",add_link)}b.find(".post_button").attr("aria-label",d);b.find(".cancel_button").attr("aria-label",cancel_button)},G=function(a){var b=c(".board_column[data-ident="+a+"]"),d=b.find(".column_name").text();b.find(".newnote").attr("aria-label",i.aria_newpost.replace("{column}",d));b.find(".delete_column").attr("aria-label",i.aria_deletecolumn.replace("{column}",d));b.find(".board_note").each(function(a,b){F(c(b).data("ident"))})},H=function(){p=null;q=null;r=null;I()},I=function(){if(!s){v(0).remove();B();return}if(p){w(s).html(p);p=null}if(q){y(s).html(q);q=null}var a=v(s);if(a){if(r){M(a,r);r=null}else{R(a)}A(a).hide();D(a).hide();B();var b=z(a);if(!b.html()){b.hide()}}s=0},J=function(a){if(s){if(s==a){return}I()}if(a){var b=v(0);if(b){b.remove()}}var c=v(a);if(c){A(c).show();D(c).show();C();var d=z(c);if(a){r=N(c);p=x(c).html();q=d.html();s=a}d.show()}},K=function(a){if(confirm(i.remove_note_text)){u("delete_note",{id:a},function(b){if(b.status){l=b.historyid;v(a).remove()}})}},L=function(a){var b=D(a),c=b.find(".type").val(),d=b.find(".info"),e=b.find(".url");if(o==j){var f=b.find(".type_icon"),g=b.find(".remove_attachment")}else{A(a).find(".attachment_button").hide()}if("0"<c){if(o==j){g.show()}d.prop("placeholder",i["option_"+O(c)+"_info"]);e.prop("placeholder",i["option_"+O(c)+"_url"]);d.show();e.show();if(o==j){f.removeClass().addClass(["type_icon","fa",Q(c)]);f.show();A(a).find(".attachment_button").hide()}}else{if(o==j){g.hide()}d.hide();e.hide();if(o==j){f.hide()}d.val("");e.val("");if(o==j){A(a).find(".attachment_button").show()}}},M=function(a,b){var c=D(a);if(c){if(!b){b={type:"0"}}else{b.type+=""}var d=c.find(".type");d.val(b.type?b.type:"0");if("0"<d.val()){c.find(".info").val(b.info);c.find(".url").val(b.url)}L(a,b)}R(a,b)},N=function(a){var b={type:0,info:null,url:null},c=D(a);if(c){b.type=c.find(".type").val();b.info=c.find(".info").val();b.url=c.find(".url").val()}if((!b.info||!b.info.length)&&(!b.url||!b.url.length)){b.type=0}return b},O=function(a){switch(a){case"1":return"youtube";case"2":return"image";case"3":return"link";default:return null;}},P=["fa-youtube","fa-picture-o","fa-link"],Q=function(a){return P[a-1]||null},R=function(a,b){var c=a.find(".preview");if(!b){b=N(a)}var d=function(a){return a.replace(/watch\?v=/gi,"/embed/").replace(/youtu\.be/,"youtube.com/embed")};if(!x(a).html().length){c.addClass("notext")}else{c.removeClass("notext")}c.removeClass("wrapper_youtube");c.removeClass("wrapper_image");c.removeClass("wrapper_url");if(b.url){switch(parseInt(b.type)){case 1:c.html("<iframe src=\""+d(b.url)+"\" class=\"preview_element\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>");c.addClass("wrapper_youtube");c.show();break;case 2:c.html("<img src=\""+b.url+"\" class=\"preview_element\" alt=\""+b.info+"\"/>");c.addClass("wrapper_image");c.show();break;case 3:c.html("<a href=\""+b.url+"\" class=\"preview_element\" target=\"_blank\">"+(b.info||b.url)+"</a>");c.addClass("wrapper_url");c.show();break;default:c.html("");c.hide();}}else{c.html("");c.hide()}},S=function(a,b,d,e,k,p){var q=p.id==n||!b,r=m||q&&!t;if(!b){var w=v(0);if(w){w.remove()}}var x=c("<div class=\"board_note\" data-ident=\""+b+"\"></div>");if(q){x.addClass("mynote")}if(r){x.addClass("editablenote")}var y=c("<div class=\"note_content\"></div>"),z=c("<div class=\"note_heading\" tabindex=\"0\">"+(d?d:"")+"</div>"),A=c("<div class=\"note_text\" tabindex=\"0\">"+(e?e:"")+"</div>"),C=c("<div class=\"note_ariatext hidden\" role=\"heading\" aria-level=\"4\" tabindex=\"0\"></div>"),D=c("<div class=\"preview\"></div>");if(r){var E=c("<div class=\"note_attachment form-group row\" tabindex=\"0\"><select class=\"type form-control form-control-sm "+(o==j?"hidden":"")+"\"><option value=\"0\">"+i.option_empty+"</option><option value=\"1\">"+i.option_youtube+"</option><option value=\"2\">"+i.option_image+"</option><option value=\"3\">"+i.option_link+"</option></select><span class=\"type_icon fa "+(o==2?"hidden":"")+"\"></span><input type=\"text\" class=\"info form-control form-control-sm col-sm-12 "+(o==j?"with_type_icon":"")+"\" placeholder=\"\"><input type=\"text\" class=\"url form-control form-control-sm col-sm-12\" placeholder=\"\"></div>");E.hide()}y.append(z);y.append(A);y.append(C);if(r){y.append(E)}y.append(D);x.append(y);if(r){var G=E.find(".type"),O=E.find(".info"),Q=E.find(".url"),T=E.find(".type_icon");G.on("change",function(){L(x);R(x)});Q.on("change",function(){R(x)});O.on("change",function(){R(x)});if(o==j){var U=c("<div class=\"remove remove_attachment fa fa-remove\"></div>");U.hide();U.on("click",function(){G.val(0);G.trigger("change")});E.append(U)}}var V=c(".board_column[data-ident="+a+"] .board_column_content");if(r){var W=c("<div class=\"note_buttons\"></div>");W.hide();var X=c("<div class=\"post_button action_button\" role=\"button\" tabindex=\"0\">"+i.post_button_text+"</div>"),Z=c("<div class=\"cancel_button action_button\" role=\"button\" tabindex=\"0\">"+i.cancel_button_text+"</div>");W.append(X);W.append(Z);if(o==j){W.append("<div class=\"spacer_button\"></div>");var $=c("<div class=\"attachment_button youtube_button action_button fa "+P[0]+"\" role=\"button\" tabindex=\"0\"></div>");g($,function(){G.val(1);G.trigger("change")});var _=c("<div class=\"attachment_button image_button action_button fa "+P[1]+"\" role=\"button\" tabindex=\"0\"></div>");g(_,function(){G.val(2);G.trigger("change")});var aa=c("<div class=\"attachment_button link_button action_button fa "+P[2]+"\" role=\"button\" tabindex=\"0\"></div>");g(aa,function(){G.val(3);G.trigger("change")});W.append($);W.append(_);W.append(aa)}x.append(W);var ba=c("<div class=\"remove fa fa-remove delete_note\" role=\"button\" tabindex=\"0\"></div>");g(ba,function(){K(b)});if(!b){ba.hide()}y.append(ba);g(Z,function(){I()});A.on("click",function(){if(s&&s==b||!b){A.editable("open")}});var ca=function(){J(b)};z.on("click",function(){if(s&&s==b||!b){z.editable("open")}});D.on("dblclick",ca);g(X,function(){var c=N(x),d=z.html(),e=A.html().substring(0,f.post_max_length);if(!b){u("add_note",{columnid:a,heading:d,content:e,attachment:c},function(b){l=b.historyid;x.remove();B();S(a,b.id,d,e,c,{id:n});Y(V);F(b.id)})}else{u("update_note",{id:b,heading:d,content:e,attachment:c},function(a){if(a.status){M(x,c);H();l=a.historyid;A.html(e);F(b)}})}});h(A,ca);A.editable({toggleFontSize:!1,closeOnEnter:!1,callback:function callback(){A.html(A.html().substring(0,f.post_max_length))}});h(z,ca);z.editable({toggleFontSize:!1,closeOnEnter:!0});M(x,k)}else{R(x,k)}if(b){if(!z.html()){z.hide()}var da=V.find(".board_note").last();if(da.length){x.insertAfter(da)}else{V.prepend(x)}}else{c(".board_column[data-ident="+a+"] .board_column_newcontent").append(x);F(b);A.editable("open");ca()}},T=function(a,b,d){var e=m,j=null,k=c("<div class=\"board_column board_column_hasdata\" data-ident=\""+a+"\"></div>"),o=c("<div class=\"board_column_header\"></div>"),p=c("<div class=\"column_sort fa\"></div>"),q=c("<div class=\"column_name\" tabindex=\"0\" aria-level=\"3\" role=\"heading\">"+b+"</div>"),r=c("<div class=\"board_column_content\"></div>"),s=c("<div class=\"board_column_newcontent\"></div>");o.append(p);o.append(q);p.on("click",function(){Y(r,!0)});if(e){k.addClass("editablecolumn");var v=c("<div class=\"remove fa fa-remove delete_column\" role=\"button\" tabindex=\"0\"></div>");g(v,function(){if(confirm(i.remove_column_text)){u("delete_column",{id:a},function(a){if(a.status){k.remove();l=a.historyid}})}});o.append(v)}k.append(o);k.append(r);k.append(s);if(e){h(q,function(){j=q.html()},!0);q.editable({toggleFontSize:!1,closeOnEnter:!0,callback:function callback(b){if(b.content){u("update_column",{id:a,name:q.html()},function(b){if(!b.status){q.html(j);j=null}else{l=b.historyid;G(a)}},function(){q.html(j);j=null})}else{q.html(j);j=null}}})}if(!t){s.append("<div class=\"board_button newnote\" role=\"button\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa "+f.noteicon+"\"></span></div></div>");g(s.find(".newnote"),function(){S(a,0,null,null,null,{id:n})})}var w=c(".mod_board .board_column_hasdata").last();if(w.length){k.insertAfter(w)}else{c(".mod_board").append(k)}if(d){for(index in d){S(a,d[index].id,d[index].heading,d[index].content,{type:d[index].type,info:d[index].info,url:d[index].url},{id:d[index].userid})}}Y(r,!0);G(a)},U=function(){var a=c("<div class=\"board_column board_column_empty\"></div>"),d=!1;a.append("<div class=\"board_button newcolumn\" role=\"button\" tabindex=\"0\" aria-label=\""+i.aria_newcolumn+"\"><div class=\"button_content\"><span class=\"fa "+f.columnicon+"\"></span></div></div>");g(a.find(".newcolumn"),function(){if(d){return}d=!0;u("add_column",{boardid:b.id,name:i.default_column_heading},function(a){T(a.id,i.default_column_heading);l=a.historyid;d=!1},function(){d=!1})});c(".mod_board").append(a)},V=function(){u("board_history",{id:b.id,since:l},function(a){for(index in a){var e=a[index];if(e.boardid!=b.id){continue}var f=JSON.parse(e.content);if("add_note"==e.action){S(f.columnid,f.id,f.heading,f.content,f.attachment,{id:e.userid});F(f.id)}else if("update_note"==e.action){var g=v(f.id);if(g){var h=z(g),j=function(){h.html(f.heading);if(f.heading){h.show()}else{h.hide()}x(g).html(f.content);M(g,f.attachment);p=null;q=null;r=null;F(f.id)};if(s==f.id){d.confirm(i.note_changed_text.split("\n")[0],i.note_changed_text.split("\n")[1],i.Ok,i.Cancel,function(){if(s==f.id){j()}I()})}else{j()}}}else if("delete_note"==e.action){if(s==f.id){d.alert(i.warning,i.note_deleted_text);I()}v(f.id).remove()}else if("add_column"==e.action){T(f.id,f.name)}else if("update_column"==e.action){c(".board_column[data-ident='"+f.id+"'] .column_name").html(f.name);G(f.id)}else if("delete_column"==e.action){var k=c(".board_column[data-ident='"+f.id+"']");if(s&&k.find(".board_note[data-ident=\""+s+"\"]").length){I()}k.remove()}l=e.id}W()})},W=function(a){if(a){V()}else{if(k){X()}k=setTimeout(V,2e3)}},X=function(){clearTimeout(k);k=null},Y=function(a,b){var d=c(a).parent().find(".column_sort"),e=c(a).data("sort");if(b){e="asc"==e?"desc":"asc"}if("asc"==e){d.removeClass("fa-angle-down");d.addClass("fa-angle-up")}else{d.removeClass("fa-angle-up");d.addClass("fa-angle-down")}c(a).data("sort",e);c("> .board_note",c(a)).sort("asc"==e?function(d,a){return c(a).data("ident")<c(d).data("ident")?1:-1}:function(d,a){return c(a).data("ident")<c(d).data("ident")?-1:1}).appendTo(c(a))},Z=function(){u("get_board",{id:b.id},function(a){if(a){for(index in a){T(a[index].id,a[index].name,a[index].notes||{})}}if(m){U()}l=b.historyid})},$=[];for(string in i){$.push({key:string,component:"mod_board"})}c.when(a.get_strings($)).done(function(a){var b=0;for(string in i){i[string]=a[b++]}Z()})}});
//# sourceMappingURL=board.min.js.map
