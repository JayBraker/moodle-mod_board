define ("mod_board/board",["jquery","jqueryui","core/str","core/ajax","core/notification","core/templates","mod_board/jquery.editable.amd"],function(c,a,b,d,e){var f=function(a,b,c,f){d.call([{methodname:"mod_board_"+a,args:b,done:function(a){c(a)}.bind(this),fail:function fail(a){e.exception(a);if(f){f(a)}}}])},g=function(a){return 13==a||32==a},h=function(a){return c("<div />").text(a).html()},i=function(a){return c("<div />").html(a).text()},j=function(a,b){return a.on("click keypress",function(a){if("keypress"==a.type){if(g(a.keyCode)){a.preventDefault()}else{return}}b()})},k=function(a,b,c){if(a.is(":editable")){throw new Error("handleEditableAction - must be called before setting the element as editable")}return a.on("dblclick keypress",function(d){if("keypress"==d.type){if(g(d.keyCode)&&!a.is(":editing")){d.preventDefault();if(c){b()}a.editable("open");if(c){return}}else{return}}b()})};return function(a,d){var g={default_column_heading:"",post_button_text:"",cancel_button_text:"",remove_note_text:"",remove_column_text:"",note_changed_text:"",note_deleted_text:"",rate_note_text:"",Ok:"",Cancel:"",warning:"",option_youtube:"",option_youtube_info:"",option_youtube_url:"",option_image:"",option_image_info:"",option_image_url:"",option_link:"",option_link_info:"",option_link_url:"",option_empty:"",aria_newcolumn:"",aria_newpost:"",aria_deletecolumn:"",aria_deletepost:"",aria_addmedia:"",aria_addmedianew:"",aria_deleteattachment:"",aria_postedit:"",aria_canceledit:"",aria_postnew:"",aria_cancelnew:"",aria_choosefilenew:"",aria_choosefileedit:"",aria_ratepost:"",choose_file:"",invalid_file_extension:"",invalid_file_size_min:"",invalid_file_size_max:""},l=1,m=1,n=2,o=3,p=1,q=2,r=null,s=null,t=d.isEditor||!1,u=d.userId||-1,v=d.mediaselection||l,w=null,x=null,y=null,z=0,A=d.readonly||!1,B=d.file.extensions,C=d.file.size_min,D=d.file.size_max,E=d.ratingenabled,F=d.sortby||p,G=function(a,b,c,d){if("board_history"!==a){ja()}f(a,b,function(){c.apply(null,arguments);if("board_history"!==a&&"get_board"!=a){ia(!0)}},d)},H=function(a){return c(".board_note[data-ident='"+a+"']")},I=function(a){return c(".board_note[data-ident='"+a+"'] .note_text")},J=function(a){return c(a).find(".note_text")},K=function(a){return c(".board_note[data-ident='"+a+"'] .note_heading")},L=function(a){return c(a).find(".note_heading")},M=function(a){return c(a).find(".note_buttons")},N=function(){c(".board_column .board_column_newcontent .board_button.newnote").show()},O=function(){c(".board_column .board_column_newcontent .board_button.newnote").hide()},P=function(a){return c(a).find(".note_attachment")},Q=function(a){var b=J(a).html(),c=L(a).html(),d=$(a);if(0<c.length){return c}if(0<b.length){return b.replace(/<br\s*\/?>/gi," ").replace(/\n/g," ").split(/\s+/).slice(0,5).join(" ")}if(d.info&&0<d.info.length){return d.info}return null},R=function(a){var b=H(a),c=b.closest(".board_column").find(".column_name").text(),d=cancel_button=add_youtube=add_image=add_link=remove_attachment=choose_file_button="";if(!a){d=g.aria_postnew.replace("{column}",c);cancel_button=g.aria_cancelnew.replace("{column}",c);add_youtube=g.aria_addmedianew.replace("{type}",g.option_youtube).replace("{column}",c);add_image=g.aria_addmedianew.replace("{type}",g.option_image).replace("{column}",c);add_link=g.aria_addmedianew.replace("{type}",g.option_link).replace("{column}",c);choose_file_button=g.aria_choosefilenew.replace("{column}",g.columnIdentifier)}else{var e=Q(b);d=g.aria_postedit.replace("{column}",c).replace("{post}",e);cancel_button=g.aria_canceledit.replace("{column}",c).replace("{post}",e);add_youtube=g.aria_addmedia.replace("{type}",g.option_youtube).replace("{column}",c).replace("{post}",e);add_image=g.aria_addmedia.replace("{type}",g.option_image).replace("{column}",c).replace("{post}",e);add_link=g.aria_addmedia.replace("{type}",g.option_link).replace("{column}",c).replace("{post}",e);remove_attachment=g.aria_deleteattachment.replace("{column}",c).replace("{post}",e);choose_file_button=g.aria_choosefileedit.replace("{column}",c).replace("{post}",e);b.find(".delete_note").attr("aria-label",g.aria_deletepost.replace("{column}",c).replace("{post}",e));b.find(".rating").attr("aria-label",g.aria_ratepost.replace("{column}",c).replace("{post}",e));b.find(".note_ariatext").html(e)}if(v==l){if(a){var f=b.find(".remove_attachment");if(f){f.attr("aria-label",remove_attachment)}}b.find(".attachment_button.youtube_button").attr("aria-label",add_youtube);b.find(".attachment_button.image_button").attr("aria-label",add_image);b.find(".attachment_button.link_button").attr("aria-label",add_link)}b.find(".post_button").attr("aria-label",d);b.find(".cancel_button").attr("aria-label",cancel_button);b.find(".choose_file_button").attr("aria-label",choose_file_button)},S=function(a){var b=c(".board_column[data-ident="+a+"]"),d=b.find(".column_name").text();b.find(".newnote").attr("aria-label",g.aria_newpost.replace("{column}",d));b.find(".delete_column").attr("aria-label",g.aria_deletecolumn.replace("{column}",d));b.find(".board_note").each(function(a,b){R(c(b).data("ident"))})},T=function(){w=null;x=null;y=null;U()},U=function(){if(!z){H(0).remove();N();return}if(w){I(z).html(w);w=null}if(x){K(z).html(x);x=null}var a=H(z);if(a){if(y){Z(a,y);y=null}else{da(a)}M(a).hide();P(a).hide();N();var b=L(a);if(!b.html()){b.hide()}}z=0},V=function(a){if(z){if(z==a){return}U()}if(a){var b=H(0);if(b){b.remove()}}var c=H(a);if(c){M(c).show();P(c).show();O();var d=L(c);if(a){y=$(c);w=J(c).html();x=d.html();z=a}d.show()}},W=function(a){if(confirm(g.remove_note_text)){G("delete_note",{id:a},function(b){if(b.status){s=b.historyid;H(a).remove()}})}},X=function(a){if(!E)return;if(A)return;G("can_rate_note",{id:a},function(b){if(b){if(confirm(g.rate_note_text)){G("rate_note",{id:a},function(b){if(b.status){s=b.historyid;var c=H(a);c.find(".rating").html(b.rating);if(F==q){ka(c.closest(".board_column_content"))}}})}}})},Y=function(a){var b=P(a),c=b.find(".type").val(),d=b.find(".info"),e=b.find(".url"),f=b.find(".file");if(v==l){var h=b.find(".type_icon"),i=b.find(".remove_attachment")}else{M(a).find(".attachment_button").hide()}if("0"<c){if(v==l){i.show()}d.prop("placeholder",g["option_"+_(c)+"_info"]);e.prop("placeholder",g["option_"+_(c)+"_url"]);d.show();if(c==n&&FileReader){f.show();e.hide()}else{f.hide();e.show()}if(v==l){h.removeClass().addClass(["type_icon","fa",ba(c)]);h.show();M(a).find(".attachment_button").hide()}}else{if(v==l){i.hide()}d.hide();e.hide();f.hide();if(v==l){h.hide()}d.val("");e.val("");if(v==l){M(a).find(".attachment_button").show()}}},Z=function(a,b){var c=P(a);if(c){if(!b){b={type:"0"}}else{b.type+=""}var d=c.find(".type");d.val(b.type?b.type:"0");if("0"<d.val()){c.find(".info").val(i(b.info));c.find(".url").val(i(b.url))}Y(a,b)}da(a,b)},$=function(a){var b={type:0,info:null,url:null,filename:null,filecontents:null},c=P(a);if(c.length){b.type=c.find(".type").val();b.info=h(c.find(".info").val());b.url=h(c.find(".url").val());var d=c.find(".file>input");if(d.data("filename")){b.filename=d.data("filename");b.filecontents=d.data("filecontents")}}if((!b.info||!b.info.length)&&(!b.url||!b.url.length)&&!b.filename){b.type=0}return b},_=function(a){switch(a){case"1":return"youtube";case"2":return"image";case"3":return"link";default:return null;}},aa=["fa-youtube","fa-picture-o","fa-link"],ba=function(a){return aa[a-1]||null},ca=function(a,b){var c=P(a);if(c.length){var d=c.find(".file>input");if(FileReader&&d.prop("files").length){var f=d.prop("files")[0];if(-1==B.indexOf(f.name.split(".").pop().toLowerCase())){e.alert(g.warning,g.invalid_file_extension)}else if(f.size<C){e.alert(g.warning,g.invalid_file_size_min)}else if(f.size>D){e.alert(g.warning,g.invalid_file_size_max)}else{d.data("filename",f.name);var h=new FileReader;h.onload=function(){d.data("filecontents",h.result);b();d.val("")};h.readAsDataURL(f)}}else{b()}}else{b()}},da=function(a,b){var c=a.find(".preview");if(!b){b=$(a)}var d=function(a){return a.replace(/watch\?v=/gi,"/embed/").replace(/youtu\.be/,"youtube.com/embed")};if(!J(a).html().length){c.addClass("notext")}else{c.removeClass("notext")}c.removeClass("wrapper_youtube");c.removeClass("wrapper_image");c.removeClass("wrapper_url");if(b.filename&&parseInt(b.type)==n){c.html("<img src=\""+b.filecontents+"\" class=\"preview_element\" alt=\""+b.info+"\"/>");c.addClass("wrapper_image");c.show()}else if(b.url){switch(parseInt(b.type)){case m:c.html("<iframe src=\""+d(b.url)+"\" class=\"preview_element\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>");c.addClass("wrapper_youtube");c.show();break;case n:c.html("<img src=\""+b.url+"\" class=\"preview_element\" alt=\""+b.info+"\"/>");c.addClass("wrapper_image");c.show();break;case o:c.html("<a href=\""+b.url+"\" class=\"preview_element\" target=\"_blank\">"+(b.info||b.url)+"</a>");c.addClass("wrapper_url");c.show();break;default:c.html("");c.hide();}}else{c.html("");c.hide()}},ea=function(a,b,e,f,h,i,p,q){var r=i.id==u||!b,w=t||r&&!A;if(!b){var x=H(0);if(x){x.remove()}}var y=c("<div class=\"board_note\" data-ident=\""+b+"\" data-sortorder=\""+p+"\"></div>");if(r){y.addClass("mynote")}if(w){y.addClass("editablenote")}var B=c("<div class=\"note_content\"></div>"),C=c("<div class=\"note_heading\" tabindex=\"0\">"+(e?e:"")+"</div>"),D=c("<div class=\"note_text\" tabindex=\"0\">"+(f?f:"")+"</div>"),F=c("<div class=\"note_ariatext hidden\" role=\"heading\" aria-level=\"4\" tabindex=\"0\"></div>"),I=c("<div class=\"preview\"></div>");if(w){var J=c("<div class=\"note_attachment form-group row\" tabindex=\"0\"><select class=\"type form-control form-control-sm "+(v==l?"hidden":"")+"\"><option value=\"0\">"+g.option_empty+"</option><option value=\""+m+"\">"+g.option_youtube+"</option><option value=\""+n+"\">"+g.option_image+"</option><option value=\""+o+"\">"+g.option_link+"</option></select><span class=\"type_icon fa "+(v==2?"hidden":"")+"\"></span><input type=\"text\" class=\"info form-control form-control-sm col-sm-12 "+(v==l?"with_type_icon":"")+"\" placeholder=\"\"><input type=\"text\" class=\"url form-control form-control-sm col-sm-12\" placeholder=\"\"><div class=\"file form-control form-control-sm\"><label for=\"file"+b+"\" class=\"choose_file_button action_button p-0 w-100\" tabindex=\"0\">"+g.choose_file+"</label><input id=\"file"+b+"\" type=\"file\" class=\"d-none\"></div></div>");J.hide()}B.append(C);B.append(D);B.append(F);if(w){B.append(J)}B.append(I);y.append(B);if(w){var K=J.find(".type"),L=J.find(".info"),M=J.find(".url"),O=J.find(".file>input"),P=J.find(".type_icon");K.on("change",function(){Y(y);da(y)});M.on("change",function(){da(y)});O.on("change",function(){ca(y,function(){da(y)})});L.on("change",function(){da(y)});if(v==l){var Q=c("<div class=\"remove remove_attachment fa fa-remove\"></div>");Q.hide();Q.on("click",function(){K.val(0);K.trigger("change")});J.append(Q)}}var S=c(".board_column[data-ident="+a+"] .board_column_content");if(w){var _=c("<div class=\"note_buttons\"></div>");_.hide();var ba=c("<div class=\"post_button action_button\" role=\"button\" tabindex=\"0\">"+g.post_button_text+"</div>"),fa=c("<div class=\"cancel_button action_button\" role=\"button\" tabindex=\"0\">"+g.cancel_button_text+"</div>");_.append(ba);_.append(fa);if(v==l){_.append("<div class=\"spacer_button\"></div>");var ga=c("<div class=\"attachment_button youtube_button action_button fa "+aa[0]+"\" role=\"button\" tabindex=\"0\"></div>");j(ga,function(){K.val(1);K.trigger("change")});var ha=c("<div class=\"attachment_button image_button action_button fa "+aa[1]+"\" role=\"button\" tabindex=\"0\"></div>");j(ha,function(){K.val(2);K.trigger("change")});var ia=c("<div class=\"attachment_button link_button action_button fa "+aa[2]+"\" role=\"button\" tabindex=\"0\"></div>");j(ia,function(){K.val(3);K.trigger("change")});_.append(ga);_.append(ha);_.append(ia)}y.append(_);var ja=c("<div class=\"remove fa fa-remove delete_note\" role=\"button\" tabindex=\"0\"></div>");j(ja,function(){W(b)});if(!b){ja.hide()}B.append(ja);j(fa,function(){U()});D.on("click",function(){if(z&&z==b||!b){D.editable("open")}});var la=function(){V(b)};C.on("click",function(){if(z&&z==b||!b){C.editable("open")}});I.on("dblclick",la);j(ba,function(){var c=$(y),e=C.html(),f=D.html().substring(0,d.post_max_length);if(!b){G("add_note",{columnid:a,heading:e,content:f,attachment:c},function(b){if(b.status){s=b.historyid;y.remove();N();ea(a,b.note.id,b.note.heading,b.note.content,{type:b.note.type,info:b.note.info,url:b.note.url},{id:b.note.userid},b.note.timecreated,b.note.rating);ka(S);R(b.note.id)}})}else{G("update_note",{id:b,heading:e,content:f,attachment:c},function(a){if(a.status){s=a.historyid;T();D.html(a.note.content);R(b);Z(y,{type:a.note.type,info:a.note.info,url:a.note.url})}})}});k(D,la);D.editable({toggleFontSize:!1,closeOnEnter:!1,callback:function callback(){D.html(D.html().substring(0,d.post_max_length))}});k(C,la);C.editable({toggleFontSize:!1,closeOnEnter:!0});Z(y,h)}else{da(y,h)}if(b){if(E){y.addClass("rateablenote");var ma=c("<div class=\"fa fa-star rating\" role=\"button\" tabindex=\"0\">"+q+"</div>");j(ma,function(){X(b)});B.append(ma)}if(!C.html()){C.hide()}var na=S.find(".board_note").last();if(na.length){y.insertAfter(na)}else{S.prepend(y)}}else{c(".board_column[data-ident="+a+"] .board_column_newcontent").append(y);R(b);D.editable("open");la()}},fa=function(a,b,e){var f=t,h=null,i=c("<div class=\"board_column board_column_hasdata\" data-ident=\""+a+"\"></div>"),l=c("<div class=\"board_column_header\"></div>"),m=c("<div class=\"column_sort fa\"></div>"),n=c("<div class=\"column_name\" tabindex=\"0\" aria-level=\"3\" role=\"heading\">"+b+"</div>"),o=c("<div class=\"board_column_content\"></div>"),p=c("<div class=\"board_column_newcontent\"></div>");l.append(m);l.append(n);if(d.hideheaders){n.addClass("d-none")}m.on("click",function(){ka(o,!0)});if(f){i.addClass("editablecolumn");var q=c("<div class=\"remove fa fa-remove delete_column\" role=\"button\" tabindex=\"0\"></div>");j(q,function(){if(confirm(g.remove_column_text)){G("delete_column",{id:a},function(a){if(a.status){i.remove();s=a.historyid}})}});l.append(q)}i.append(l);i.append(o);i.append(p);if(f){k(n,function(){h=n.html()},!0);n.editable({toggleFontSize:!1,closeOnEnter:!0,callback:function callback(b){if(b.content){G("update_column",{id:a,name:n.html()},function(b){if(!b.status){n.html(h);h=null}else{s=b.historyid;S(a)}},function(){n.html(h);h=null})}else{n.html(h);h=null}}})}if(!A){p.append("<div class=\"board_button newnote\" role=\"button\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa "+d.noteicon+"\"></span></div></div>");j(p.find(".newnote"),function(){ea(a,0,null,null,null,{id:u},0,0)})}var r=c(".mod_board .board_column_hasdata").last();if(r.length){i.insertAfter(r)}else{c(".mod_board").append(i)}if(e){for(index in e){ea(a,e[index].id,e[index].heading,e[index].content,{type:e[index].type,info:e[index].info,url:e[index].url},{id:e[index].userid},e[index].timecreated,e[index].rating)}}ka(o);S(a);t&&la()},ga=function(){var b=c("<div class=\"board_column board_column_empty\"></div>"),e=!1;b.append("<div class=\"board_button newcolumn\" role=\"button\" tabindex=\"0\" aria-label=\""+g.aria_newcolumn+"\"><div class=\"button_content\"><span class=\"fa "+d.columnicon+"\"></span></div></div>");j(b.find(".newcolumn"),function(){if(e){return}e=!0;G("add_column",{boardid:a.id,name:g.default_column_heading},function(a){fa(a.id,g.default_column_heading);s=a.historyid;e=!1},function(){e=!1})});c(".mod_board").append(b)},ha=function(){G("board_history",{id:a.id,since:s},function(b){for(index in b){var d=b[index];if(d.boardid!=a.id){continue}var f=JSON.parse(d.content);if("add_note"==d.action){ea(f.columnid,f.id,f.heading,f.content,f.attachment,{id:d.userid},f.timecreated,f.rating);R(f.id);ka(c(".board_column[data-ident="+f.columnid+"] .board_column_content"))}else if("update_note"==d.action){var h=H(f.id);if(h){var i=L(h),j=function(){i.html(f.heading);if(f.heading){i.show()}else{i.hide()}J(h).html(f.content);Z(h,f.attachment);w=null;x=null;y=null;R(f.id)};if(z==f.id){e.confirm(g.note_changed_text.split("\n")[0],g.note_changed_text.split("\n")[1],g.Ok,g.Cancel,function(){if(z==f.id){j()}U()})}else{j()}}}else if("delete_note"==d.action){if(z==f.id){e.alert(g.warning,g.note_deleted_text);U()}H(f.id).remove()}else if("add_column"==d.action){fa(f.id,f.name)}else if("update_column"==d.action){c(".board_column[data-ident='"+f.id+"'] .column_name").html(f.name);S(f.id)}else if("delete_column"==d.action){var k=c(".board_column[data-ident='"+f.id+"']");if(z&&k.find(".board_note[data-ident=\""+z+"\"]").length){U()}k.remove()}else if("rate_note"==d.action){var h=H(f.id);h.find(".rating").html(f.rating);if(F==q){ka(h.closest(".board_column_content"))}}s=d.id}ia()})},ia=function(a){if(a){ha()}else if(0<d.history_refresh){if(r){ja()}r=setTimeout(ha,1e3*d.history_refresh)}},ja=function(){clearTimeout(r);r=null},ka=function(a,b){var d=c(a).parent().find(".column_sort"),e=c(a).data("sort");if(!e){if(F==q){e="desc"}else{e="asc"}}if(b){e="asc"==e?"desc":"asc"}if("asc"==e){d.removeClass("fa-angle-down");d.addClass("fa-angle-up")}else{d.removeClass("fa-angle-up");d.addClass("fa-angle-down")}c(a).data("sort",e);if(F==p){var f=function(d,a){return c(a).data("sortorder")-c(d).data("sortorder")},g=function(d,a){return c(d).data("sortorder")-c(a).data("sortorder")}}else if(F==q){var f=function(d,a){return c(a).find(".rating").text()-c(d).find(".rating").text()||c(a).data("sortorder")-c(d).data("sortorder")},g=function(d,a){return c(d).find(".rating").text()-c(a).find(".rating").text()||c(d).data("sortorder")-c(a).data("sortorder")}}c("> .board_note",c(a)).sort("asc"==e?g:f).appendTo(c(a))},la=function(){c(".board_column_content").sortable({connectWith:".board_column_content",stop:function stop(a,b){var d=c(b.item),e=d.closest(".board_column"),f=e.data("ident"),g=c(this);G("move_note",{id:d.data("ident"),columnid:f},function(a){if(a.status){s=a.historyid;R(d.data("ident"));ka(c(".board_column[data-ident="+f+"] .board_column_content"))}else{g.sortable("cancel")}})}})},ma=function(){G("get_board",{id:a.id},function(b){if(b){for(index in b){fa(b[index].id,b[index].name,b[index].notes||{})}}t&&ga();s=a.historyid;t&&la();ia()})},na=[];for(string in g){na.push({key:string,component:"mod_board"})}c.when(b.get_strings(na)).done(function(a){var b=0;for(string in g){g[string]=a[b++]}ma()})}});
//# sourceMappingURL=board.min.js.map
