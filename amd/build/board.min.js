define ("mod_board/board",["jquery","core/str","core/ajax","core/notification","mod_board/jquery.editable.amd"],function(a,b,c,d){var e=function(a,b,e,f){c.call([{methodname:"mod_board_"+a,args:b,done:function(a){e(a)}.bind(this),fail:function fail(a){d.exception(a);if(f){f(a)}}}])};return function(c,f){var g={default_column_heading:"",post_button_text:"",cancel_button_text:"",remove_note_text:"",remove_column_text:"",note_changed_text:"",note_deleted_text:"",Ok:"",Cancel:"",warning:""},h=null,i=null,j=f.isEditor||!1,k=f.userId||-1,l=null,m=0,n=function(a,b,c,d){if("board_history"!==a){A()}e(a,b,function(){c.apply(null,arguments);if("board_history"!==a){z(!0)}},d)},o=function(b){return a(".board_note[data-ident='"+b+"']")},p=function(b){return a(".board_note[data-ident='"+b+"'] .note_text")},q=function(){a(".board_column .board_column_content .board_button.newnote").show()},r=function(){a(".board_column .board_column_content .board_button.newnote").hide()},s=function(){if(l){p(m).html(l);l=null}var a=o(m);if(a){a.find(".note_buttons").hide();q()}m=0},t=function(a){if(m&&m!=a){s()}var b=o(0);if(b){b.remove()}var c=o(a);if(c){c.find(".note_buttons").show();r();l=c.find(".note_text").html();m=a}},u=function(a){if(confirm(g.remove_note_text)){n("delete_note",{id:a},function(b){if(b.status){i=b.historyid;o(a).remove()}})}},v=function(b,c,d,e){var f=e.id==k||!c,h=j||f;if(!c){var m=o(0);if(m){m.remove()}}var p=a("<div class=\"board_note\" data-ident=\""+c+"\"></div>");if(f){p.addClass("mynote")}if(h){p.addClass("editablenote")}var w=a("<div class=\"note_content\"></div>"),x=a("<div class=\"note_text\" tabindex=\"0\">"+d+"</div>");w.append(x);p.append(w);var y=a(".board_column[data-ident="+b+"] .board_column_content");if(h){var z=a("<div class=\"note_buttons\"></div>");z.hide();var A=a("<div class=\"post_button\" role=\"button\" tabindex=\"0\">"+g.post_button_text+"</div>"),B=a("<div class=\"cancel_button\" role=\"button\" tabindex=\"0\">"+g.cancel_button_text+"</div>");z.append(A);z.append(B);p.append(z);var C=a("<div class=\"remove fa fa-remove\" role=\"button\" tabindex=\"0\"></div>");C.on("click keypress",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault()}else{return}}u(c)});if(!c){C.hide()}w.append(C);B.on("click keypress",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault()}else{return}}if(!c){p.remove();q()}else{s()}});x.on("dblclick keypress",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault();x.dblclick();return}else{return}}if(c){t(c)}else{r();z.show()}});A.on("click keypress",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault()}else{return}}if(!c){n("add_note",{columnid:b,content:x.html()},function(a){i=a.historyid;p.remove();q();v(b,a.id,x.html(),{id:k})})}else{n("update_note",{id:c,content:x.html()},function(a){if(a.status){l=null;s();i=a.historyid}})}});x.editable({toggleFontSize:!1,closeOnEnter:!1,callback:function callback(a){if(!c&&!a.$el[0].innerHTML){p.remove();q()}}})}var D=y.find(".board_note").last();if(D.length){p.insertAfter(D)}else{y.prepend(p)}if(!c){x.dblclick()}},w=function(b,c,d){var e=j,h=null,l=a("<div class=\"board_column board_column_hasdata\" data-ident=\""+b+"\"></div>"),m=a("<div class=\"board_column_header\"></div>"),o=a("<div class=\"column_name\" tabindex=\"0\">"+c+"</div>"),p=a("<div class=\"board_column_content\"></div>");m.append(o);if(e){l.addClass("editablecolumn");var q=a("<div class=\"remove fa fa-remove\" role=\"button\" tabindex=\"0\"></div>");q.on("click keypress",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault()}else{return}}if(confirm(g.remove_column_text)){n("delete_column",{id:b},function(a){if(a.status){l.remove();i=a.historyid}})}});m.append(q)}l.append(m);l.append(p);if(e){o.on("dblclick keypress",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault();o.dblclick()}else{return}}h=o.html()});o.editable({toggleFontSize:!1,closeOnEnter:!0,callback:function callback(a){if(a.content){n("update_column",{id:b,name:o.html()},function(a){if(!a.status){o.html(h);h=null}else{i=a.historyid}},function(){o.html(h);h=null})}else{o.html(h);h=null}}})}p.append("<div class=\"board_button newnote\" role=\"button\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa "+f.noteicon+"\"></span></div></div>");p.on("click keypress",".newnote",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault()}else{return}}v(b,0,"",{id:k})});var r=a(".mod_board .board_column_hasdata").last();if(r.length){l.insertAfter(r)}else{a(".mod_board").append(l)}if(d){for(index in d){v(b,d[index].id,d[index].content,{id:d[index].userid})}}},x=function(){var b=a("<div class=\"board_column board_column_empty\"></div>");b.append("<div class=\"board_button newcolumn\" role=\"button\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa "+f.columnicon+"\"></span></div></div>");b.on("click keypress",".newcolumn",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault()}else{return}}n("add_column",{boardid:c.id,name:g.default_column_heading},function(a){w(a.id,g.default_column_heading);i=a.historyid})});a(".mod_board").append(b)},y=function(){n("board_history",{id:c.id,since:i},function(b){for(index in b){var e=b[index];if(e.boardid!=c.id){continue}if("add_note"==e.action){v(e.columnid,e.noteid,e.content,{id:e.userid})}else if("update_note"==e.action){var f=o(e.noteid);if(f){if(m==e.noteid){l=e.content;d.confirm(g.note_changed_text.split("\n")[0],g.note_changed_text.split("\n")[1],g.Ok,g.Cancel,function(){if(m==e.noteid){f.find(".note_text").html(e.content)}s()})}else{f.find(".note_text").html(e.content)}}}else if("delete_note"==e.action){if(m==e.noteid){d.alert(g.warning,g.note_deleted_text);s()}a(".board_note[data-ident='"+e.noteid+"']").remove()}else if("add_column"==e.action){w(e.columnid,e.content)}else if("update_column"==e.action){a(".board_column[data-ident='"+e.columnid+"'] .column_name").html(e.content)}else if("delete_column"==e.action){var h=a(".board_column[data-ident='"+e.columnid+"']");if(m&&h.find(".board_note[data-ident=\""+m+"\"]").length){s()}h.remove()}i=e.id}z()})},z=function(a){if(a){y()}else{if(h){A()}h=setTimeout(y,2e3)}},A=function(){clearTimeout(h);h=null},B=function(){n("get_board",{id:c.id},function(a){if(a){for(index in a){w(a[index].id,a[index].name,a[index].notes||{})}}if(j){x()}i=c.historyid})},C=[];for(string in g){C.push({key:string,component:"mod_board"})}a.when(b.get_strings(C)).done(function(a){var b=0;for(string in g){g[string]=a[b++]}B()})}});
//# sourceMappingURL=board.min.js.map
