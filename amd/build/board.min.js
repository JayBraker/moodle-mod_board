define ("mod_board/board",["jquery","core/str","core/ajax","core/notification","core/templates","mod_board/jquery.editable.amd"],function(c,a,b,d){var e=function(a,c,e,f){b.call([{methodname:"mod_board_"+a,args:c,done:function(a){e(a)}.bind(this),fail:function fail(a){d.exception(a);if(f){f(a)}}}])},f=function(a){return 13===a||32===a};return function(b,g){var h={default_column_heading:"",post_button_text:"",cancel_button_text:"",remove_note_text:"",remove_column_text:"",note_changed_text:"",note_deleted_text:"",Ok:"",Cancel:"",warning:"",option_youtube:"",option_youtube_info:"",option_youtube_url:"",option_image:"",option_image_info:"",option_image_url:"",option_link:"",option_link_info:"",option_link_url:"",option_empty:"",aria_newcolumn:"",aria_newpost:"",aria_deletecolumn:"",aria_deletepost:"",aria_addmedia:"",aria_deleteattachment:""},i=1,j=null,k=null,l=g.isEditor||!1,m=g.userId||-1,n=g.mediaselection||i,o=null,p=null,q=null,r=0,s=g.readonly||!1,t=function(a,b,c,d){if("board_history"!==a){T()}e(a,b,function(){c.apply(null,arguments);if("board_history"!==a){S(!0)}},d)},u=function(a){return c(".board_note[data-ident='"+a+"']")},v=function(a){return c(".board_note[data-ident='"+a+"'] .note_text")},w=function(a){return c(a).find(".note_text")},x=function(a){return c(".board_note[data-ident='"+a+"'] .note_heading")},y=function(a){return c(a).find(".note_heading")},z=function(a){return c(a).find(".note_buttons")},A=function(){c(".board_column .board_column_newcontent .board_button.newnote").show()},B=function(){c(".board_column .board_column_newcontent .board_button.newnote").hide()},C=function(a){return c(a).find(".note_attachment")},D=function(){o=null;p=null;q=null;E()},E=function(){if(!r){u(0).remove();A();return}if(o){v(r).html(o);o=null}if(p){x(r).html(p);p=null}var a=u(r);if(a){if(q){I(a,q);q=null}else{N(a)}z(a).hide();C(a).hide();A();var b=y(a);if(!b.html()){b.hide()}}r=0},F=function(a){if(r){if(r==a){return}E()}if(a){var b=u(0);if(b){b.remove()}}var c=u(a);if(c){z(c).show();C(c).show();B();var d=y(c);if(a){q=J(c);o=w(c).html();p=d.html();r=a}d.show()}},G=function(a){if(confirm(h.remove_note_text)){t("delete_note",{id:a},function(b){if(b.status){k=b.historyid;u(a).remove()}})}},H=function(a){var b=C(a),c=b.find(".type").val(),d=b.find(".info"),e=b.find(".url");if(n==i){var f=b.find(".type_icon"),g=b.find(".remove_attachment")}else{z(a).find(".attachment_button").hide()}if("0"<c){if(n==i){g.show()}d.prop("placeholder",h["option_"+K(c)+"_info"]);e.prop("placeholder",h["option_"+K(c)+"_url"]);d.show();e.show();if(n==i){f.removeClass().addClass(["type_icon","fa",M(c)]);f.show();z(a).find(".attachment_button").hide()}}else{if(n==i){g.hide()}d.hide();e.hide();if(n==i){f.hide()}d.val("");e.val("");if(n==i){z(a).find(".attachment_button").show()}}},I=function(a,b){var c=C(a);if(c){if(!b){b={type:"0"}}else{b.type+=""}var d=c.find(".type");d.val(b.type?b.type:"0");if("0"<d.val()){c.find(".info").val(b.info);c.find(".url").val(b.url)}H(a,b)}N(a,b)},J=function(a){var b={type:0,info:null,url:null},c=C(a);if(c){b.type=c.find(".type").val();b.info=c.find(".info").val();b.url=c.find(".url").val()}if(!b.info.length&&!b.url.length){b.type=0}return b},K=function(a){switch(a){case"1":return"youtube";case"2":return"image";case"3":return"link";default:return null;}},L=["fa-youtube","fa-picture-o","fa-link"],M=function(a){return L[a-1]||null},N=function(a,b){var c=a.find(".preview");if(!b){b=J(a)}var d=function(a){return a.replace(/watch\?v=/gi,"/embed/").replace(/youtu\.be/,"youtube.com/embed")};if(!w(a).html().length){c.addClass("notext")}else{c.removeClass("notext")}c.removeClass("wrapper_youtube");c.removeClass("wrapper_image");c.removeClass("wrapper_url");if(b.url){switch(parseInt(b.type)){case 1:c.html("<iframe src=\""+d(b.url)+"\" class=\"preview_element\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>");c.addClass("wrapper_youtube");c.show();break;case 2:c.html("<img src=\""+b.url+"\" class=\"preview_element\" alt=\""+b.info+"\"/>");c.addClass("wrapper_image");c.show();break;case 3:c.html("<a href=\""+b.url+"\" class=\"preview_element\" target=\"_blank\">"+(b.info||b.url)+"</a>");c.addClass("wrapper_url");c.show();break;default:c.html("");c.hide();}}else{c.html("");c.hide()}},O=function(a,b,d,e,g,j){var o=j.id==m||!b,p=l||o&&!s;if(!b){var q=u(0);if(q){q.remove()}}var v=c("<div class=\"board_note\" data-ident=\""+b+"\"></div>");if(o){v.addClass("mynote")}if(p){v.addClass("editablenote")}var w=c("<div class=\"note_content\"></div>"),x=c("<div class=\"note_heading\" tabindex=\"0\" aria-level=\"4\" role=\"heading\">"+(d?d:"")+"</div>"),y=c("<div class=\"note_text\" tabindex=\"0\">"+(e?e:"")+"</div>"),z=c("<div class=\"preview\"></div>");if(p){var B=c("<div class=\"note_attachment form-group row\" tabindex=\"0\"><select class=\"type form-control form-control-sm "+(n==i?"hidden":"")+"\"><option value=\"0\">"+h.option_empty+"</option><option value=\"1\">"+h.option_youtube+"</option><option value=\"2\">"+h.option_image+"</option><option value=\"3\">"+h.option_link+"</option></select><span class=\"type_icon fa "+(n==2?"hidden":"")+"\"></span><input type=\"text\" class=\"info form-control form-control-sm col-sm-12 "+(n==i?"with_type_icon":"")+"\" placeholder=\"\"><input type=\"text\" class=\"url form-control form-control-sm col-sm-12\" placeholder=\"\"></div>");B.hide()}w.append(x);w.append(y);if(p){w.append(B)}w.append(z);v.append(w);if(p){var C=B.find(".type"),K=B.find(".info"),M=B.find(".url"),P=B.find(".type_icon");C.on("change",function(){H(v);N(v)});M.on("change",function(){N(v)});K.on("change",function(){N(v)});if(n==i){var Q=c("<div class=\"remove remove_attachment fa fa-remove\" aria-label=\""+h.aria_deleteattachment+"\"></div>");Q.hide();Q.on("click",function(){C.val(0);C.trigger("change")});B.append(Q)}}var R=c(".board_column[data-ident="+a+"] .board_column_content"),S=c(".board_column[data-ident="+a+"] .column_name");if(p){var T=c("<div class=\"note_buttons\"></div>");T.hide();var V=c("<div class=\"post_button action_button\" role=\"button\" tabindex=\"0\">"+h.post_button_text+"</div>"),W=c("<div class=\"cancel_button action_button\" role=\"button\" tabindex=\"0\">"+h.cancel_button_text+"</div>");T.append(V);T.append(W);if(n==i){T.append("<div class=\"spacer_button\"></div>");var X=c("<div class=\"attachment_button youtube_button action_button fa "+L[0]+"\" role=\"button\" aria-label=\""+h.aria_addmedia.replace("{type}",h.option_youtube)+"\" tabindex=\"0\"></div>");X.on("click",function(){C.val(1);C.trigger("change")});var Y=c("<div class=\"attachment_button image_button action_button fa "+L[1]+"\" role=\"button\" aria-label=\""+h.aria_addmedia.replace("{type}",h.option_image)+"\" tabindex=\"0\"></div>");Y.on("click",function(){C.val(2);C.trigger("change")});var Z=c("<div class=\"attachment_button link_button action_button fa "+L[2]+"\" role=\"button\" aria-label=\""+h.aria_addmedia.replace("{type}",h.option_link)+"\" tabindex=\"0\"></div>");Z.on("click",function(){C.val(3);C.trigger("change")});T.append(X);T.append(Y);T.append(Z)}v.append(T);var $=c("<div class=\"remove fa fa-remove\" role=\"button\" aria-label=\""+h.aria_deletepost.replace("{column}",S.text()).replace("{post}",x.text())+"\" tabindex=\"0\"></div>");$.on("click keypress",function(a){if("keypress"==a.type){if(f(a.keyCode)){a.preventDefault()}else{return}}G(b)});if(!b){$.hide()}w.append($);W.on("click keypress",function(a){if("keypress"==a.type){if(f(a.keyCode)){a.preventDefault()}else{return}}E()});y.on("click",function(){if(r&&r==b||!b){y.editable("open")}});var _=function(){F(b)};y.on("dblclick keypress",function(a){if("keypress"==a.type){if(f(a.keyCode)&&!y.is(":editing")){a.preventDefault();y.dblclick();return}else{return}}_()});x.on("click",function(){if(r&&r==b||!b){x.editable("open")}});x.on("dblclick keypress",function(a){if("keypress"==a.type){if(f(a.keyCode)&&!x.is(":editing")){a.preventDefault();x.dblclick();return}else{return}}_()});z.on("dblclick",function(){_()});V.on("click keypress",function(c){if("keypress"==c.type){if(f(c.keyCode)){c.preventDefault()}else{return}}var d=J(v);if(!b){var e=x.html(),g=y.html();t("add_note",{columnid:a,heading:e,content:g,attachment:d},function(b){k=b.historyid;v.remove();A();O(a,b.id,e,g,d,{id:m});U(R)})}else{t("update_note",{id:b,heading:x.html(),content:y.html(),attachment:d},function(a){if(a.status){I(v,d);D();k=a.historyid}})}});y.editable({toggleFontSize:!1,closeOnEnter:!1});x.editable({toggleFontSize:!1,closeOnEnter:!0});I(v,g)}else{N(v,g)}if(b){if(!x.html()){x.hide()}var aa=R.find(".board_note").last();if(aa.length){v.insertAfter(aa)}else{R.prepend(v)}}else{c(".board_column[data-ident="+a+"] .board_column_newcontent").append(v);y.dblclick()}},P=function(a,b,d){var e=l,i=null,j=c("<div class=\"board_column board_column_hasdata\" data-ident=\""+a+"\"></div>"),n=c("<div class=\"board_column_header\"></div>"),o=c("<div class=\"column_sort fa\"></div>"),p=c("<div class=\"column_name\" tabindex=\"0\" aria-level=\"3\" role=\"heading\">"+b+"</div>"),q=c("<div class=\"board_column_content\"></div>"),r=c("<div class=\"board_column_newcontent\"></div>");n.append(o);n.append(p);o.on("click",function(){U(q,!0)});if(e){j.addClass("editablecolumn");var u=c("<div class=\"remove fa fa-remove\" role=\"button\" aria-label=\""+h.aria_deletecolumn.replace("{column}",p.text())+"\" tabindex=\"0\"></div>");u.on("click keypress",function(b){if("keypress"==b.type){if(f(b.keyCode)){b.preventDefault()}else{return}}if(confirm(h.remove_column_text)){t("delete_column",{id:a},function(a){if(a.status){j.remove();k=a.historyid}})}});n.append(u)}j.append(n);j.append(q);j.append(r);if(e){p.on("dblclick keypress",function(a){if("keypress"==a.type){if(f(a.keyCode)&&!p.is(":editing")){a.preventDefault();p.dblclick()}else{return}}i=p.html()});p.editable({toggleFontSize:!1,closeOnEnter:!0,callback:function callback(b){if(b.content){t("update_column",{id:a,name:p.html()},function(a){if(!a.status){p.html(i);i=null}else{k=a.historyid}},function(){p.html(i);i=null})}}})}if(!s){r.append("<div class=\"board_button newnote\" role=\"button\" aria-label=\""+h.aria_newpost.replace("{column}",p.text())+"\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa "+g.noteicon+"\"></span></div></div>");r.on("click keypress",".newnote",function(b){if("keypress"==b.type){if(f(b.keyCode)){b.preventDefault()}else{return}}O(a,0,null,null,null,{id:m})})}var v=c(".mod_board .board_column_hasdata").last();if(v.length){j.insertAfter(v)}else{c(".mod_board").append(j)}if(d){for(index in d){O(a,d[index].id,d[index].heading,d[index].content,{type:d[index].type,info:d[index].info,url:d[index].url},{id:d[index].userid})}}U(q,!0)},Q=function(){var a=c("<div class=\"board_column board_column_empty\"></div>"),d=!1;a.append("<div class=\"board_button newcolumn\" role=\"button\" tabindex=\"0\" aria-label=\""+h.aria_newcolumn+"\"><div class=\"button_content\"><span class=\"fa "+g.columnicon+"\"></span></div></div>");a.on("click keypress",".newcolumn",function(a){if(d){return}d=!0;if("keypress"==a.type){if(f(a.keyCode)){a.preventDefault()}else{return}}t("add_column",{boardid:b.id,name:h.default_column_heading},function(a){P(a.id,h.default_column_heading);k=a.historyid;d=!1},function(){d=!1})});c(".mod_board").append(a)},R=function(){t("board_history",{id:b.id,since:k},function(a){for(index in a){var e=a[index];if(e.boardid!=b.id){continue}var f=JSON.parse(e.content);if("add_note"==e.action){O(f.columnid,f.id,f.heading,f.content,f.attachment,{id:e.userid})}else if("update_note"==e.action){var g=u(f.id);if(g){var i=y(g),j=function(){i.html(f.heading);if(f.heading){i.show()}else{i.hide()}w(g).html(f.content);I(g,f.attachment);o=null;p=null;q=null};if(r==f.id){d.confirm(h.note_changed_text.split("\n")[0],h.note_changed_text.split("\n")[1],h.Ok,h.Cancel,function(){if(r==f.id){j()}E()})}else{j()}}}else if("delete_note"==e.action){if(r==f.id){d.alert(h.warning,h.note_deleted_text);E()}u(f.id).remove()}else if("add_column"==e.action){P(f.id,f.name)}else if("update_column"==e.action){c(".board_column[data-ident='"+f.id+"'] .column_name").html(f.name)}else if("delete_column"==e.action){var l=c(".board_column[data-ident='"+f.id+"']");if(r&&l.find(".board_note[data-ident=\""+r+"\"]").length){E()}l.remove()}k=e.id}S()})},S=function(a){if(a){R()}else{if(j){T()}j=setTimeout(R,2e3)}},T=function(){clearTimeout(j);j=null},U=function(a,b){var d=c(a).parent().find(".column_sort"),e=c(a).data("sort");if(b){e="asc"==e?"desc":"asc"}if("asc"==e){d.removeClass("fa-angle-down");d.addClass("fa-angle-up")}else{d.removeClass("fa-angle-up");d.addClass("fa-angle-down")}c(a).data("sort",e);c("> .board_note",c(a)).sort("asc"==e?function(d,a){return c(a).data("ident")<c(d).data("ident")?1:-1}:function(d,a){return c(a).data("ident")<c(d).data("ident")?-1:1}).appendTo(c(a))},V=function(){t("get_board",{id:b.id},function(a){if(a){for(index in a){P(a[index].id,a[index].name,a[index].notes||{})}}if(l){Q()}k=b.historyid})},W=[];for(string in h){W.push({key:string,component:"mod_board"})}c.when(a.get_strings(W)).done(function(a){var b=0;for(string in h){h[string]=a[b++]}V()})}});
//# sourceMappingURL=board.min.js.map
