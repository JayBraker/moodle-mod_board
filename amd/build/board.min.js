define ("mod_board/board",["exports","jquery","jqueryui","core/str","core/ajax","core/modal_factory","core/modal_events","core/notification","mod_board/jquery.editable.amd","core/fragment"],function(a,c,d,e,f,g,h,i,j,k){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.default=m;c=l(c);f=l(f);g=l(g);h=l(h);i=l(i);k=l(k);function l(a){return a&&a.__esModule?a:{default:a}}var n=function(a,b,c,d){f.default.call([{methodname:"mod_board_"+a,args:b,done:function done(a){c(a)},fail:function fail(a){i.default.exception(a);if(d){d(a)}}}])},o=function(a){return 13==a||32==a},p=function(a){return(0,c.default)("<div />").text(a).html()},q=function(a){return(0,c.default)("<div />").html(a).text()},r=function(a,b){return a.on("click keypress",function(a){if("keypress"==a.type){if(o(a.keyCode)){a.preventDefault()}else{return}}b()})},s=function(a,b,c){if(a.is(":editable")){throw new Error("handleEditableAction - must be called before setting the element as editable")}return a.on("dblclick keypress",function(d){if("keypress"==d.type){if(o(d.keyCode)&&!a.is(":editing")){d.preventDefault();if(c){b()}a.editable("open");if(c){return}}else{return}}b()})};function m(a,b,d){var f={default_column_heading:"",post_button_text:"",cancel_button_text:"",remove_note_title:"",remove_note_text:"",remove_column_title:"",note_changed_title:"",note_changed_text:"",note_deleted_text:"",rate_note_text:"",Ok:"",delete:"",Cancel:"",warning:"",modal_title_new:"",modal_title_edit:"",option_youtube:"",option_image:"",option_link:"",aria_newcolumn:"",aria_newpost:"",aria_deletecolumn:"",aria_deletepost:"",aria_addmedia:"",aria_addmedianew:"",aria_deleteattachment:"",aria_postedit:"",aria_canceledit:"",aria_postnew:"",aria_cancelnew:"",aria_ratepost:"",invalid_file_extension:"",invalid_file_size_min:"",invalid_file_size_max:"",invalid_youtube_url:""},j=1,l=2,m=1,o=2,t=null,u=null,v=b.isEditor||!1,w=b.usersCanEdit,x=b.userId||-1,y=b.mediaselection||j,z=0,A=b.readonly||!1,B=b.ratingenabled,C=b.sortby||m,D=null,E=function(a,b,c,d){if("board_history"!==a){fa()}n(a,b,function(){c.apply(null,arguments);if("board_history"!==a&&"get_board"!=a){ea(!0)}},d)},F=function(a){return(0,c.default)(".board_note[data-ident='"+a+"']")},G=function(a){return(0,c.default)(a).find(".mod_board_note_text")},H=function(a){return(0,c.default)(a).find(".mod_board_note_heading")},I=function(a){return(0,c.default)(a).find(".mod_board_note_border")},J=function(a){return(0,c.default)(a).find(".mod_board_note_attachment")},K=function(a){var b=G(a).html(),c=H(a).html(),d=U(a);if(0<c.length){return c}if(0<b.length){return b.replace(/<br\s*\/?>/gi," ").replace(/\n/g," ").split(/\s+/).slice(0,5).join(" ")}if(d.info&&0<d.info.length){return d.info}return null},L=function(a){var b=F(a),c=b.closest(".board_column").find(".mod_board_column_name").text();if(a){var d=K(b),e=f.aria_deletepost.replace("{column}",c).replace("{post}",d);b.find(".delete_note").attr("aria-label",e).attr("title",e);b.find(".mod_board_rating").attr("aria-label",f.aria_ratepost.replace("{column}",c).replace("{post}",d));b.find(".note_ariatext").html(d)}},N=function(a){var b=(0,c.default)(".board_column[data-ident="+a+"]"),d=b.find(".mod_board_column_name").text(),e=f.aria_newpost.replace("{column}",d),g=f.aria_deletecolumn.replace("{column}",d);b.find(".newnote").attr("aria-label",e).attr("title",e);b.find(".delete_column").attr("aria-label",g).attr("title",g);b.find(".board_note").each(function(a,b){L((0,c.default)(b).data("ident"))})},O=function(){if(!z){F(0).remove();return}var a=F(z);if(a){var b=H(a),c=G(a),d=I(a);b.show();d.show();c.show();if(!b.html()){b.hide();d.hide()}if(!c.html()&&b.html()){c.hide();d.hide()}}z=0},P=function(a){if(z){if(z==a){return}O()}if(a){var b=F(0);if(b){b.remove()}}var c=F(a);if(c){ka(c);if(a){z=a}}},Q=function(a){i.default.confirm(f.remove_note_title,f.remove_note_text,f.delete,f.Cancel,function(){E("delete_note",{id:a},function(b){if(b.status){u=b.historyid;F(a).remove()}})})},R=function(a){if(!B){return}if(A){return}var b=F(a),c=b.find(".mod_board_rating");if(c.data("disabled")){return}c.data("disabled",!0);E("can_rate_note",{id:a},function(d){if(d){i.default.confirm(f.rate_note_text,null,f.Ok,f.Cancel,function(){E("rate_note",{id:a},function(a){if(a.status){u=a.historyid;c.html(a.rating);if(C==o){ga(b.closest(".board_column_content"))}}c.data("disabled",!1)})}).then(function(a){a.getRoot().on(h.default.hidden,function(){c.data("disabled",!1)})})}})},S=function(a){var b=J(a),c=b.find(".mod_board_type").val(),d=b.find(".info"),e=b.find(".url"),g=b.find(".mod_board_file");if("0"<c){d.prop("placeholder",f["option_"+V(c)+"_info"]);e.prop("placeholder",f["option_"+V(c)+"_url"]);d.show();if(c==l&&FileReader){g.show();e.hide()}else{g.hide();e.show()}}else{d.hide();e.hide();g.hide();d.val("");e.val("")}},T=function(a,b){var c=J(a);if(c){if(!b){b={type:"0"}}else{b.type+=""}var d=c.find(".mod_board_type");d.val(b.type?b.type:"0");if("0"<d.val()){c.find(".info").val(q(b.info));c.find(".url").val(q(b.url))}S(a,b)}X(a,b)},U=function(a){var b={type:0,info:null,url:null,filename:null,filecontents:null},c=J(a);if(c.length){b.type=c.find(".mod_board_type").val();b.info=p(c.find(".info").val());b.url=p(c.find(".url").val());var d=c.find(".mod_board_file>input");if(d.data("filename")){b.filename=d.data("filename");b.filecontents=d.data("filecontents")}}if((!b.info||!b.info.length)&&(!b.url||!b.url.length)&&!b.filename){b.type=0}return b},V=function(a){switch(a){case"1":return"youtube";case"2":return"image";case"3":return"link";default:return null;}},W=function(a){var b=a.match(/(\/|%3D|v=)([0-9A-z-_]{11})([%#?&]|$)/);if(!b||b[2]===void 0||11!==b[2].length){return null}return"https://youtube.com/embed/".concat(b[2])},X=function(a,b){var c=a.find(".mod_board_preview");if(!b){b=U(a)}if(!G(a).html().length){c.addClass("mod_board_notext")}else{c.removeClass("mod_board_notext")}c.removeClass("wrapper_youtube");c.removeClass("wrapper_image");c.removeClass("wrapper_url");if(b.filename&&parseInt(b.type)==l){c.html("<img src=\"".concat(b.filecontents,"\" alt=\"").concat(b.info,"\"\n                class=\"mod_board_preview_element\"/>"));c.addClass("wrapper_image");c.show()}else if(b.url){switch(parseInt(b.type)){case 1:{var d=W(b.url);if(null===d){c.html(f.invalid_youtube_url)}else{c.html("<iframe src=\""+d+"\" class=\"mod_board_preview_element\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write;encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>");c.addClass("wrapper_youtube")}c.show()}break;case l:c.html("<img src=\"".concat(b.url,"\" alt=\"").concat(b.info,"\"\n                        class=\"mod_board_preview_element\"/>"));c.addClass("wrapper_image");c.show();break;case 3:c.html("<a href=\""+b.url+"\" class=\"mod_board_preview_element\" target=\"_blank\">"+(b.info||b.url)+"</a>");c.addClass("wrapper_url");c.show();break;default:c.html("");c.hide();}}else{c.html("");c.hide()}},Z=function(a,b,d,e,f,g,h,i){var j=g.id==x||!b,k=v||j&&!A;if(!b){var l=F(0);if(l){l.remove()}}var m=(0,c.default)("<div class=\"board_note\" data-column=\""+a+"\" data-ident=\""+b+"\" data-sortorder=\""+h+"\"></div>");if(j){m.addClass("mod_board_mynote")}if(k){m.addClass("mod_board_editablenote")}var n=(0,c.default)("<div class=\"mod_board_note_content\"></div>"),o=(0,c.default)("<div class=\"mod_board_note_heading\" tabindex=\"0\">"+(d?d:"")+"</div>"),p=(0,c.default)("<div class=\"mod_board_note_border\"></div>"),q=(0,c.default)("<div class=\"mod_board_note_text\" tabindex=\"0\">"+(e?e:"")+"</div>"),t=(0,c.default)("<div class=\"note_ariatext hidden\" role=\"heading\" aria-level=\"4\" tabindex=\"0\"></div>"),u=(0,c.default)("<div class=\"mod_board_preview\"></div>");n.append(o);n.append(p);n.append(q);n.append(t);n.append(u);m.append(n);var w=(0,c.default)(".board_column[data-ident="+a+"] .board_column_content"),y=function(){P(b)};if(b){if(B){m.addClass("mod_board_rateablenote");var z=(0,c.default)("<div class=\"fa fa-star mod_board_rating\" role=\"button\" tabindex=\"0\"> ".concat(i," </div>"));r(z,function(){R(b)});n.append(z)}if(k){var C=(0,c.default)("<div class=\"mod_board_remove fa fa-remove delete_note\" role=\"button\" tabindex=\"0\"></div>");r(C,function(){Q(b)});n.append(C);s(q,y);s(o,y);s(p,y);T(m,f)}else{X(m,f)}if(!o.html()){o.hide();p.hide()}if(!q.html()&&o.html()){q.hide();p.hide()}var D=w.find(".board_note").last();if(D.length){m.insertAfter(D)}else{w.prepend(m)}}else{(0,c.default)(".board_column[data-ident="+a+"] .board_column_newcontent").append(m);m.hide();y()}},$=function(a,d,g,h){var j="style=\"border-top: 10px solid #".concat(h,"\""),k=v,l=null,m=(0,c.default)("<div class=\"board_column board_column_hasdata\" ".concat(j," data-ident=\"").concat(a,"\"></div>")),n=(0,c.default)("<div class=\"board_column_header\"></div>"),o=(0,c.default)("<div class=\"mod_board_column_sort fa\"></div>"),p=(0,c.default)("<div class=\"mod_board_column_name\" tabindex=\"0\" aria-level=\"3\" role=\"heading\">"+d+"</div>"),q=(0,c.default)("<div class=\"board_column_content\"></div>"),t=(0,c.default)("<div class=\"board_column_newcontent\"></div>");n.append(o);n.append(p);if(b.hideheaders){p.addClass("d-none")}o.on("click",function(){ga(q,!0)});if(k){m.addClass("mod_board_editablecolumn");var y=(0,c.default)("<div class=\"mod_board_remove fa fa-remove delete_column\" role=\"button\" tabindex=\"0\"></div>");r(y,function(){i.default.confirm(f.remove_column_title,(0,e.get_string)("remove_column_text","mod_board",_(a)),f.delete,f.Cancel,function(){E("delete_column",{id:a},function(a){if(a.status){m.remove();u=a.historyid}})})});n.append(y)}m.append(n);m.append(q);m.append(t);if(k){s(p,function(){l=p.html()},!0);p.editable({toggleFontSize:!1,closeOnEnter:!0,callback:function callback(b){if(b.content){E("update_column",{id:a,name:p.html()},function(b){if(!b.status){p.html(l);l=null}else{u=b.historyid;N(a)}},function(){p.html(l);l=null})}else{p.html(l);l=null}}})}if(!A){t.append("<div class=\"board_button newnote\" role=\"button\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa "+b.noteicon+"\"></span></div></div>");r(t.find(".newnote"),function(){Z(a,0,null,null,null,{id:x},0,0)})}var z=(0,c.default)(".mod_board .board_column_hasdata").last();if(z.length){m.insertAfter(z)}else{(0,c.default)(".mod_board").append(m)}if(g){for(var B in g){Z(a,g[B].id,g[B].heading,g[B].content,{type:g[B].type,info:g[B].info,url:g[B].url},{id:g[B].userid},g[B].timecreated,g[B].rating)}}ga(q);N(a);if(v||1==w){ha()}},_=function(a){return(0,c.default)(".board_column[data-ident='".concat(a,"']")).find(".mod_board_column_name").html()},aa=function(){var d=(0,c.default)("<div class=\"board_column board_column_empty\"></div>"),e=!1;d.append("<div class=\"board_button newcolumn\" role=\"button\" tabindex=\"0\" aria-label=\""+f.aria_newcolumn+"\" title=\""+f.aria_newcolumn+"\"><div class=\"button_content\"><span class=\"fa "+b.columnicon+"\"></span></div></div>");r(d.find(".newcolumn"),function(){if(e){return}e=!0;E("add_column",{boardid:a.id,name:f.default_column_heading},function(a){$(a.id,f.default_column_heading,{},ba());u=a.historyid;e=!1},function(){e=!1})});(0,c.default)(".mod_board").append(d)},ba=function(){var a=(0,c.default)(".board_column").length-1,d=b.colours.length;return b.colours[a%d]},ca=function(a,b,c){var d=H(a),e=G(a),f=I(a);e.html(c.content);d.html(c.heading);T(a,c.attachment);L(c.id);d.show();f.show();e.show();if(!d.html()){d.hide();f.hide()}if(!e.html()&&d.html()){e.hide();f.hide()}},da=function(){E("board_history",{id:a.id,since:u},function(b){for(var d in b){var e=b[d];if(e.boardid!=a.id){continue}var g=JSON.parse(e.content);if("add_note"==e.action){Z(g.columnid,g.id,g.heading,g.content,g.attachment,{id:e.userid},g.timecreated,g.rating);L(g.id);ga((0,c.default)(".board_column[data-ident="+g.columnid+"] .board_column_content"))}else if("update_note"==e.action){(function(){var a=F(g.id),b=D;if(a){var c=H(a);if(z==g.id){i.default.confirm(f.note_changed_title,f.note_changed_text,f.Ok,f.Cancel,function(){b.hide();ca(a,c,g);O()})}else{ca(a,c,g)}}})()}else if("delete_note"==e.action){if(z==g.id){i.default.alert(f.warning,f.note_deleted_text);O()}F(g.id).remove()}else if("add_column"==e.action){$(g.id,g.name,{},ba())}else if("update_column"==e.action){(0,c.default)(".board_column[data-ident='"+g.id+"'] .mod_board_column_name").html(g.name);N(g.id)}else if("delete_column"==e.action){var h=(0,c.default)(".board_column[data-ident='"+g.id+"']");if(z&&h.find(".board_note[data-ident=\""+z+"\"]").length){O()}h.remove()}else if("rate_note"==e.action){var j=F(g.id);j.find(".mod_board_rating").html(g.rating);if(C==o){ga(j.closest(".board_column_content"))}}u=e.id}ea()})},ea=function(a){if(a){da()}else if(0<b.history_refresh){if(t){fa()}t=setTimeout(da,1e3*b.history_refresh)}},fa=function(){clearTimeout(t);t=null},ga=function(a,b){var d=(0,c.default)(a).parent().find(".mod_board_column_sort"),e=(0,c.default)(a).data("sort");if(!e){if(C==o){e="desc"}else{e="asc"}}if(b){e="asc"==e?"desc":"asc"}if("asc"==e){d.removeClass("fa-angle-down");d.addClass("fa-angle-up")}else{d.removeClass("fa-angle-up");d.addClass("fa-angle-down")}(0,c.default)(a).data("sort",e);var f,g;if(C==m){f=function(d,a){return(0,c.default)(a).data("sortorder")-(0,c.default)(d).data("sortorder")};g=function(d,a){return(0,c.default)(d).data("sortorder")-(0,c.default)(a).data("sortorder")}}else{f=function(d,a){return(0,c.default)(a).find(".mod_board_rating").text()-(0,c.default)(d).find(".mod_board_rating").text()||(0,c.default)(a).data("sortorder")-(0,c.default)(d).data("sortorder")};g=function(d,a){return(0,c.default)(d).find(".mod_board_rating").text()-(0,c.default)(a).find(".mod_board_rating").text()||(0,c.default)(d).data("sortorder")-(0,c.default)(a).data("sortorder")}}(0,c.default)("> .board_note",(0,c.default)(a)).sort("asc"===e?g:f).appendTo((0,c.default)(a))},ha=function(){(0,c.default)(".board_column_content").sortable({connectWith:".board_column_content",items:1==w&&!v?"> .board_note.mod_board_mynote":"> *",stop:function stop(a,b){var d=(0,c.default)(b.item),e=d.closest(".board_column"),f=e.data("ident"),g=(0,c.default)(this);E("move_note",{id:d.data("ident"),columnid:f},function(a){if(a.status){u=a.historyid;L(d.data("ident"));ga((0,c.default)(".board_column[data-ident="+f+"] .board_column_content"))}else{g.sortable("cancel")}})}})},ia=function(a,b){return k.default.loadFragment("mod_board","note_form",d,{noteid:a,columnid:b})},ja=function(a,b){var c=a.closest(".board_column").find(".mod_board_column_name").text(),d,e,g,h,i,k=b.getRoot();if(a.data("ident")){var l=K(a);h=f.aria_postedit.replace("{column}",c).replace("{post}",l);i=f.aria_canceledit.replace("{column}",c).replace("{post}",l);d=f.aria_addmedia.replace("{type}",f.option_youtube).replace("{column}",c).replace("{post}",l);e=f.aria_addmedia.replace("{type}",f.option_image).replace("{column}",c).replace("{post}",l);g=f.aria_addmedia.replace("{type}",f.option_link).replace("{column}",c).replace("{post}",l)}else{h=f.aria_postnew.replace("{column}",c);i=f.aria_cancelnew.replace("{column}",c);d=f.aria_addmedianew.replace("{type}",f.option_youtube).replace("{column}",c);e=f.aria_addmedianew.replace("{type}",f.option_image).replace("{column}",c);g=f.aria_addmedianew.replace("{type}",f.option_link).replace("{column}",c)}if(y==j){k.find(".mod_board_attachment_button.youtube_button").attr("aria-label",d);k.find(".mod_board_attachment_button.youtube_button").attr("title",d);k.find(".mod_board_attachment_button.image_button").attr("aria-label",e);k.find(".mod_board_attachment_button.image_button").attr("title",e);k.find(".mod_board_attachment_button.link_button").attr("aria-label",g);k.find(".mod_board_attachment_button.link_button").attr("title",g)}var m=k.find(b.getActionSelector("save"));if(m){m.attr("aria-label",h)}m=k.find(b.getActionSelector("cancel"));if(m){m.attr("aria-label",i)}},ka=function(a){var b=0,e=a.data("column"),i=(0,c.default)(".board_column[data-ident="+e+"]"),k=i.find(".mod_board_column_name").text(),l;if(a.data("ident")){b=a.data("ident");l=f.modal_title_edit.replace("{column}",k)}else{l=f.modal_title_new.replace("{column}",k)}g.default.create({type:g.default.types.SAVE_CANCEL,title:l,body:ia(b,e),large:!0,removeOnClose:!0}).then(function(b){b.getBodyPromise().then(function(){var g=!1;D=b;b.setLarge();b.setSaveButtonText(f.post_button_text);b.setButtonText("cancel",f.cancel_button_text);b.getRoot().on(h.default.hidden,function(){O();if(!a.data("ident")){a.remove()}});b.getRoot().on(h.default.save,function(a){a.preventDefault();b.getRoot().find("form").submit()});var i=document.createEvent("HTMLEvents");i.initEvent("change",!0,!0);b.getRoot().on("submit","form",function(f){f.preventDefault();if(g){return}g=!0;var h=b.getRoot().find("form").get(0).reportValidity();if(!h){return}b.getRoot().find(":input").each(function(a,b){b.dispatchEvent(i)});var j=c.default.merge(b.getRoot().find("[aria-invalid=\"true\"]"),b.getRoot().find(".error"),b.getRoot().find(":invalid"));if(j.length){j.first().focus();return}var k=JSON.stringify(b.getRoot().find("form").serialize());E("submit_form",{contextid:d,jsonformdata:k},function(d){if(d.status){if("insert"==d.action){u=d.historyid;a.remove();Z(e,d.note.id,d.note.heading,d.note.content,{type:d.note.type,info:d.note.info,url:d.note.url},{id:d.note.userid},d.note.timecreated,d.note.rating);ga((0,c.default)(".board_column[data-ident="+e+"] .board_column_content"));L(d.note.id)}else{u=d.historyid;G(a).html(d.note.content);H(a).html(d.note.heading);L(d.note.id);T(a,{type:d.note.type,info:d.note.info,url:d.note.url})}O();Y.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()});b.destroy()}})});if(y==j){b.getRoot().find("#fitem_id_mediatype").hide();var k=b.getRoot().find("#fitem_id_mediatype select"),l=b.getRoot().find(".mod_board_attachment_button.youtube_button"),m=b.getRoot().find(".mod_board_attachment_button.image_button"),n=b.getRoot().find(".mod_board_attachment_button.link_button"),o=function(){l.removeClass("selected");m.removeClass("selected");n.removeClass("selected");switch(k.val()){case"1":l.addClass("selected");break;case"2":m.addClass("selected");break;case"3":n.addClass("selected");break;}};o();r(l,function(){if("1"===k.val()){k.val(0)}else{k.val(1)}o();k[0].dispatchEvent(i)});r(m,function(){if("2"===k.val()){k.val(0)}else{k.val(2)}o();k[0].dispatchEvent(i)});r(n,function(){if("3"===k.val()){k.val(0)}else{k.val(3)}o();k[0].dispatchEvent(i)})}else{b.getRoot().find("#fitem_id_mediabuttons").hide()}ja(a,b);b.show();return b});return b})},la=function(){E("get_board",{id:a.id},function(c){if(c){for(var d in c){$(c[d].id,c[d].name,c[d].notes||{},b.colours[d%b.colours.length])}}if(v){aa()}u=a.historyid;if(v){ha()}ea()})},ma=[];for(var na in f){ma.push({key:na,component:"mod_board"})}c.default.when((0,e.get_strings)(ma)).done(function(a){var b=0;for(na in f){f[na]=a[b++]}la()})}return a.default});
//# sourceMappingURL=board.min.js.map
