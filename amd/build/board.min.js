define ("mod_board/board",["jquery","core/str","core/ajax","core/notification","mod_board/jquery.editable.amd"],function(c,a,b,d){var e=function(a,c,e,f){b.call([{methodname:"mod_board_"+a,args:c,done:function(a){e(a)}.bind(this),fail:function fail(a){d.exception(a);if(f){f(a)}}}])};return function(b,f){var g={default_column_heading:"",post_button_text:"",cancel_button_text:"",remove_note_text:"",remove_column_text:"",note_changed_text:"",note_deleted_text:"",Ok:"",Cancel:"",warning:""},h=null,i=null,j=f.isEditor||!1,k=f.userId||-1,l=null,m=0,n=function(a,b,c,d){if("board_history"!==a){A()}e(a,b,function(){c.apply(null,arguments);if("board_history"!==a){z(!0)}},d)},o=function(a){return c(".board_note[data-ident='"+a+"']")},p=function(a){return c(".board_note[data-ident='"+a+"'] .note_text")},q=function(){c(".board_column .board_column_newcontent .board_button.newnote").show()},r=function(){c(".board_column .board_column_newcontent .board_button.newnote").hide()},s=function(){if(l){p(m).html(l);l=null}var a=o(m);if(a){a.find(".note_buttons").hide();q()}m=0},t=function(a){if(m){if(m==a){return}s()}var b=o(0);if(b){b.remove()}var c=o(a);if(c){c.find(".note_buttons").show();r();l=c.find(".note_text").html();m=a}},u=function(a){if(confirm(g.remove_note_text)){n("delete_note",{id:a},function(b){if(b.status){i=b.historyid;o(a).remove()}})}},v=function(a,b,d,e){var f=e.id==k||!b,h=j||f;if(!b){var m=o(0);if(m){m.remove()}}var p=c("<div class=\"board_note\" data-ident=\""+b+"\"></div>");if(f){p.addClass("mynote")}if(h){p.addClass("editablenote")}var w=c("<div class=\"note_content\"></div>"),x=c("<div class=\"note_text\" tabindex=\"0\">"+d+"</div>");w.append(x);p.append(w);var y=c(".board_column[data-ident="+a+"] .board_column_content");if(h){var z=c("<div class=\"note_buttons\"></div>");z.hide();var A=c("<div class=\"post_button\" role=\"button\" tabindex=\"0\">"+g.post_button_text+"</div>"),C=c("<div class=\"cancel_button\" role=\"button\" tabindex=\"0\">"+g.cancel_button_text+"</div>");z.append(A);z.append(C);p.append(z);var D=c("<div class=\"remove fa fa-remove\" role=\"button\" tabindex=\"0\"></div>");D.on("click keypress",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault()}else{return}}u(b)});if(!b){D.hide()}w.append(D);C.on("click keypress",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault()}else{return}}if(!b){p.remove();q()}else{s()}});x.on("dblclick keypress",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault();x.dblclick();return}else{return}}if(b){t(b)}else{r();z.show()}});A.on("click keypress",function(c){if("keypress"==c.type){if(13===c.keyCode){c.preventDefault()}else{return}}if(!b){n("add_note",{columnid:a,content:x.html()},function(b){i=b.historyid;p.remove();q();v(a,b.id,x.html(),{id:k});B(y)})}else{n("update_note",{id:b,content:x.html()},function(a){if(a.status){l=null;s();i=a.historyid}})}});x.editable({toggleFontSize:!1,closeOnEnter:!1,callback:function callback(a){if(!b&&!a.$el[0].innerHTML){p.remove();q()}}})}if(b){var E=y.find(".board_note").last();if(E.length){p.insertAfter(E)}else{y.prepend(p)}}else{c(".board_column[data-ident="+a+"] .board_column_newcontent").append(p);x.dblclick()}},w=function(a,b,d){var e=j,h=null,l=c("<div class=\"board_column board_column_hasdata\" data-ident=\""+a+"\"></div>"),m=c("<div class=\"board_column_header\"></div>"),o=c("<div class=\"column_sort fa\"></div>"),p=c("<div class=\"column_name\" tabindex=\"0\">"+b+"</div>"),q=c("<div class=\"board_column_content\"></div>"),r=c("<div class=\"board_column_newcontent\"></div>");m.append(o);m.append(p);o.on("click",function(){B(q,!0)});if(e){l.addClass("editablecolumn");var s=c("<div class=\"remove fa fa-remove\" role=\"button\" tabindex=\"0\"></div>");s.on("click keypress",function(b){if("keypress"==b.type){if(13===b.keyCode){b.preventDefault()}else{return}}if(confirm(g.remove_column_text)){n("delete_column",{id:a},function(a){if(a.status){l.remove();i=a.historyid}})}});m.append(s)}l.append(m);l.append(q);l.append(r);if(e){p.on("dblclick keypress",function(a){if("keypress"==a.type){if(13===a.keyCode){a.preventDefault();p.dblclick()}else{return}}h=p.html()});p.editable({toggleFontSize:!1,closeOnEnter:!0,callback:function callback(b){if(b.content){n("update_column",{id:a,name:p.html()},function(a){if(!a.status){p.html(h);h=null}else{i=a.historyid}},function(){p.html(h);h=null})}}})}r.append("<div class=\"board_button newnote\" role=\"button\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa "+f.noteicon+"\"></span></div></div>");r.on("click keypress",".newnote",function(b){if("keypress"==b.type){if(13===b.keyCode){b.preventDefault()}else{return}}v(a,0,"",{id:k})});var t=c(".mod_board .board_column_hasdata").last();if(t.length){l.insertAfter(t)}else{c(".mod_board").append(l)}if(d){for(index in d){v(a,d[index].id,d[index].content,{id:d[index].userid})}}B(q,!0)},x=function(){var a=c("<div class=\"board_column board_column_empty\"></div>"),d=!1;a.append("<div class=\"board_button newcolumn\" role=\"button\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa "+f.columnicon+"\"></span></div></div>");a.on("click keypress",".newcolumn",function(a){if(d){return}d=!0;if("keypress"==a.type){if(13===a.keyCode){a.preventDefault()}else{return}}n("add_column",{boardid:b.id,name:g.default_column_heading},function(a){w(a.id,g.default_column_heading);i=a.historyid;d=!1},function(){d=!1})});c(".mod_board").append(a)},y=function(){n("board_history",{id:b.id,since:i},function(a){for(index in a){var e=a[index];if(e.boardid!=b.id){continue}if("add_note"==e.action){v(e.columnid,e.noteid,e.content,{id:e.userid})}else if("update_note"==e.action){var f=o(e.noteid);if(f){if(m==e.noteid){l=e.content;d.confirm(g.note_changed_text.split("\n")[0],g.note_changed_text.split("\n")[1],g.Ok,g.Cancel,function(){if(m==e.noteid){f.find(".note_text").html(e.content)}s()})}else{f.find(".note_text").html(e.content)}}}else if("delete_note"==e.action){if(m==e.noteid){d.alert(g.warning,g.note_deleted_text);s()}c(".board_note[data-ident='"+e.noteid+"']").remove()}else if("add_column"==e.action){w(e.columnid,e.content)}else if("update_column"==e.action){c(".board_column[data-ident='"+e.columnid+"'] .column_name").html(e.content)}else if("delete_column"==e.action){var h=c(".board_column[data-ident='"+e.columnid+"']");if(m&&h.find(".board_note[data-ident=\""+m+"\"]").length){s()}h.remove()}i=e.id}z()})},z=function(a){if(a){y()}else{if(h){A()}h=setTimeout(y,2e3)}},A=function(){clearTimeout(h);h=null},B=function(a,b){var d=c(a).parent().find(".column_sort"),e=c(a).data("sort");if(b){e="asc"==e?"desc":"asc"}if("asc"==e){d.removeClass("fa-angle-down");d.addClass("fa-angle-up")}else{d.removeClass("fa-angle-up");d.addClass("fa-angle-down")}c(a).data("sort",e);c("> .board_note",c(a)).sort("asc"==e?function(d,a){return c(a).data("ident")<c(d).data("ident")?1:-1}:function(d,a){return c(a).data("ident")<c(d).data("ident")?-1:1}).appendTo(c(a))},C=function(){n("get_board",{id:b.id},function(a){if(a){for(index in a){w(a[index].id,a[index].name,a[index].notes||{})}}if(j){x()}i=b.historyid})},D=[];for(string in g){D.push({key:string,component:"mod_board"})}c.when(a.get_strings(D)).done(function(a){var b=0;for(string in g){g[string]=a[b++]}C()})}});
//# sourceMappingURL=board.min.js.map
